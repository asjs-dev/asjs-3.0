(function(){"use strict";Array.prototype.addUnique=function(item){this.indexOf(item)==-1&&this.push(item)};Array.prototype.has=function(item){return this.indexOf(item)>-1};Array.prototype.remove=function(item){var a=this.indexOf(item);a>-1&&this.splice(a,1)};Array.prototype.clone=function(){return this.slice(0)};Array.prototype.equal=function(arr){if(!arr||arr.length!==this.length)return!1;for(var i=0;i<this.length;i++){if(this[i]!==arr[i])return!1};return!0};var arraySet=function(target,source,from){var i=0;var l=source.length;while(i<l){target[from+i]=source[i];++i}};var _d=document;var _w=window;var _m=Math;var _crel=_d.createElement;var property=function(t,n,v){v.enumerable=!0;v.configurable=!0;Object.defineProperty(t,n,v)};var prop=property;var get=function(t,n,v){prop(t,n,{get:v})};var set=function(t,n,v){prop(t,n,{set:v})};var constant=function(t,n,v){prop(t,n,{value:v})};var cnst=constant;cnst(_w,"on","addEventListener");cnst(_w,"off","removeEventListener");cnst(_w,"offAll","removeEventListeners");cnst(_w,"de","dispatchEvent");cnst(_w,"has","hasEventListener");var empty=function(a){try{return a===undefined||a===null||a===""||a.length===0}catch(e){return!0}};var emp=empty;var map=function(o,cb){for(var k in o){if(!o.hasOwnProperty(k))continue;var v=cb(k,o[k]);if(!emp(v))o[k]=v}};var emptyFunction=function(){};var ef=emptyFunction;var iterateOver=function(o,cb,ccb){if(emp(o))return b();var a=Object.keys(o);var k;var i=-1;function b(){ccb&&ccb()};function n(){i++;if(i===a.length){b();return};k=a[i];if(o.hasOwnProperty&&!o.hasOwnProperty(k))n();var c;try{c=o[k]}catch(e){};var v=cb(k,c,n,b);if(!emp(v))o[k]=v};n()};var ito=iterateOver;var createPrototypeClass=function(parent,construct,body){var a=parent.prototype;var b=construct.prototype;Object.setPrototypeOf(construct,parent);Object.setPrototypeOf(b,a);b.constructor=construct;body&&body.call(b,a);return construct};var c4=createPrototypeClass;var deleteProperty=function(t,p){var a=Object.getOwnPropertyDescriptor(t,p);if(a&&(a.get||a.set))prop(t,p,{set:ef,get:ef});else{try{t[p]=null}catch(e){}};delete t[p]};var del=deleteProperty;var destructObjectFlat=function(t,stack){ito(t,function(a,b,c){del(t,a);c()});t=null};var destObjFlat=destructObjectFlat;var BasePrototypeClass=c4(Object,function a(){},function(){this.destruct=function(){destObjFlat(this)};this.toObject=function(){return JSON.parse(JSON.stringify(this))}});console.log("AGL 1.0");_w.AGL={};AGL.CreateConfig=function(options){var b="Maximum of ";if(options.textureNum===undefined||options.textureNum>AGL.Utils.info.maxTextureImageUnits)options.textureNum=AGL.Utils.info.maxTextureImageUnits;if(options.lightNum===undefined)options.lightNum=0;else if(options.lightNum>16)options.lightNum=16;var a=options.contextAttributes||{};return{"canvas":options.canvas,"locations":options.locations||{},"textureNum":options.textureNum,"lightNum":options.lightNum,"isLightEnabled":options.lightNum>0,"isMaskEnabled":options.isMaskEnabled,"vertexShader":options.vertexShader,"fragmentShader":options.fragmentShader,"contextAttributes":{"alpha":a.alpha||!1,"antialias":a.antialias||!1,"depth":a.depth||!1,"stencil":a.stencil||!1,"premultipliedAlpha":a.premultipliedAlpha||!1,"powerPreference":a.powerPreference||"high-performance"}}};(function(){var f="ONE_MINUS_SRC_ALPHA";var g="ONE_MINUS_SRC_COLOR";var c="SRC_ALPHA";var d="DST_ALPHA";var a="ONE";function e(b){return{"funcName":b.length===2?"blendFunc":"blendFuncSeparate","funcs":b}};AGL.BlendModes={"NORMAL":e([c,f,a,f]),"ADD":e([c,d,a,d]),"MULTIPLY":e(["DST_COLOR",f]),"SCREEN":e([c,g,a,g]),"OVERLAY":e([a,f])};Object.freeze(AGL.BlendModes)})();AGL.AbstractProps=c4(BasePrototypeClass,function b(){BasePrototypeClass.call(this);this._id=-1;this._curId=-1},function(){this.isUpdated=function(){var a=this._curId<this._id;this._curId=this._id;return a}});AGL.ColorProps=c4(AGL.AbstractProps,function a(){AGL.AbstractProps.call(this);this._v=[1,1,1,1];this.items=this._v},function(){prop(this,"r",{get:function(){return this._v[0]},set:function(v){if(this._v[0]!==v){this._v[0]=v;++this._id}}});prop(this,"g",{get:function(){return this._v[1]},set:function(v){if(this._v[1]!==v){this._v[1]=v;++this._id}}});prop(this,"b",{get:function(){return this._v[2]},set:function(v){if(this._v[2]!==v){this._v[2]=v;++this._id}}});prop(this,"a",{get:function(){return this._v[3]},set:function(v){if(this._v[3]!==v){this._v[3]=v;++this._id}}})});AGL.ItemProps=c4(AGL.AbstractProps,function a(){AGL.AbstractProps.call(this);this._sWUId=0;this._curSWUId=-1;this._sHUId=0;this._curSHUId=-1;this._rUId=0;this._curSRUId=-1;this._curCRUId=-1;this._sW=1;this._sH=1;this._sr=0;this._cr=1;this._x=0;this._y=0;this._zId=0;this._r=0;this._sX=1;this._sY=1;this._w=1;this._h=1;this._aX=0;this._aY=0},function(){get(this,"scaledWidth",function(){if(this._curSWUId!==this._sWUId){this._curSWUId=this._sWUId;this._sW=this._w*this._sX};return this._sW});get(this,"scaledHeight",function(){if(this._curSHUId!==this._sHUId){this._curSHUId=this._sHUId;this._sH=this._h*this._sY};return this._sH});get(this,"sinR",function(){if(this._curSRUId!==this._rUId){this._curSRUId=this._rUId;this._sr=_m.sin(this._r)};return this._sr});get(this,"cosR",function(){if(this._curCRUId!==this._rUId){this._curCRUId=this._rUId;this._cr=_m.cos(this._r)};return this._cr});get(this,"scaledHeight",function(){if(this._curSHUId!==this._sHUId){this._curSHUId=this._sHUId;this._sH=this._h*this._sY};return this._sH});prop(this,"x",{get:function(){return this._x},set:function(v){if(this._x!==v){this._x=v;++this._id}}});prop(this,"y",{get:function(){return this._y},set:function(v){if(this._y!==v){this._y=v;++this._id}}});prop(this,"zIndex",{get:function(){return this._zId},set:function(v){this._zId!==v&&(this._zId=v)}});prop(this,"rotation",{get:function(){return this._r},set:function(v){if(this._r!==v){this._r=v;++this._rUId;++this._id}}});prop(this,"scaleX",{get:function(){return this._sX},set:function(v){if(this._sX!==v){this._sX=v;++this._sWUId;++this._id}}});prop(this,"scaleY",{get:function(){return this._sY},set:function(v){if(this._sY!==v){this._sY=v;++this._sHUId;++this._id}}});prop(this,"width",{get:function(){return this._w},set:function(v){if(this._w!==v){this._w=v;++this._sWUId;++this._id}}});prop(this,"height",{get:function(){return this._h},set:function(v){if(this._h!==v){this._h=v;++this._sHUId;++this._id}}});prop(this,"anchorX",{get:function(){return this._aX},set:function(v){if(this._aX!==v){this._aX=v;++this._id}}});prop(this,"anchorY",{get:function(){return this._aY},set:function(v){if(this._aY!==v){this._aY=v;++this._id}}})});AGL.LightEffectProps=c4(AGL.AbstractProps,function a(){AGL.AbstractProps.call(this);this._v=[0,0,2,2];this.items=this._v},function(){prop(this,"anchorX",{get:function(){return this._v[0]},set:function(v){if(this._v[0]!==v){this._v[0]=v;++this._id}}});prop(this,"anchorY",{get:function(){return this._v[1]},set:function(v){if(this._v[1]!==v){this._v[1]=v;++this._id}}});prop(this,"quadX",{get:function(){return this._v[2]},set:function(v){if(this._v[2]!==v){this._v[2]=v;++this._id}}});prop(this,"quadY",{get:function(){return this._v[3]},set:function(v){if(this._v[3]!==v){this._v[3]=v;++this._id}}})});AGL.TextureCrop=c4(AGL.AbstractProps,function a(){AGL.AbstractProps.call(this);this._w=1;this._h=1;this._v=[0,0,1,1];this.items=this._v},function(){prop(this,"x",{get:function(){return this._v[0]},set:function(v){if(this._v[0]!==v){this._v[0]=v;this._calcWidth();++this._id}}});prop(this,"y",{get:function(){return this._v[1]},set:function(v){if(this._v[1]!==v){this._v[1]=v;this._calcHeight();++this._id}}});prop(this,"width",{get:function(){return this._w},set:function(v){if(this._w!==v){this._w=v;this._calcWidth();++this._id}}});prop(this,"height",{get:function(){return this._h},set:function(v){if(this._h!==v){this._h=v;this._calcHeight();++this._id}}});this._calcWidth=function(){this._v[2]=this._w-this._v[0]};this._calcHeight=function(){this._v[3]=this._h-this._v[1]}});AGL.TextureProps=c4(AGL.AbstractProps,function a(){AGL.AbstractProps.call(this);this._rUId=0;this._curSRUId=-1;this._curCRUId=-1;this._sr=0;this._cr=1;this._x=0;this._y=0;this._r=0;this._w=1;this._h=1;this._aX=0;this._aY=0},function(){get(this,"scaledWidth",function(){return this._w});get(this,"scaledHeight",function(){return this._h});get(this,"sinR",function(){if(this._curSRUId!==this._rUId){this._curSRUId=this._rUId;this._sr=_m.sin(this._r)};return this._sr});get(this,"cosR",function(){if(this._curCRUId!==this._rUId){this._curCRUId=this._rUId;this._cr=_m.cos(this._r)};return this._cr});prop(this,"x",{get:function(){return this._x},set:function(v){if(this._x!==v){this._x=v;++this._id}}});prop(this,"y",{get:function(){return this._y},set:function(v){if(this._y!==v){this._y=v;++this._id}}});prop(this,"rotation",{get:function(){return this.this._r},set:function(v){if(this.this._r!==v){this.this._r=v;++this._rUId;++this._id}}});prop(this,"width",{get:function(){return this._w},set:function(v){if(this._w!==v){this._w=v;++this._id}}});prop(this,"height",{get:function(){return this._h},set:function(v){if(this._h!==v){this._h=v;++this._id}}});prop(this,"anchorX",{get:function(){return this._aX},set:function(v){if(this._aX!==v){this._aX=v;++this._id}}});prop(this,"anchorY",{get:function(){return this._aY},set:function(v){if(this._aY!==v){this._aY=v;++this._id}}})});AGL.Matrix3={isPointInMatrix:function(j,b,a,l,o){l[0]=b[0]*a[0]+b[3]*a[1];l[1]=b[1]*a[0]+b[4]*a[1];l[2]=b[0]*a[3]+b[3]*a[4];l[3]=b[1]*a[3]+b[4]*a[4];l[4]=b[0]*a[6]+b[3]*a[7]+b[6];l[5]=b[1]*a[6]+b[4]*a[7]+b[7];var d=1/(l[0]*l[3]-l[2]*l[1]);o[0]=d*l[3];o[1]=-d*l[1];o[2]=-d*l[2];o[3]=d*l[0];o[4]=d*(l[2]*l[5]-l[3]*l[4]);o[5]=-d*(l[0]*l[5]-l[1]*l[4]);var x=j[0]*o[0]+j[1]*o[2]+o[4];var y=j[0]*o[1]+j[1]*o[3]+o[5];return x>=0&&y>=0&&x<=1&&y<=1},identity:function(){return new Float32Array([1,0,0,0,1,0,0,0,1,])},projection:function(n,p,k){k[0]=2/n;k[1]=0;k[2]=0;k[3]=0;k[4]=-2/p;k[5]=0;k[6]=-1;k[7]=1;k[8]=1},transformLocal:function(x,y,c,e,f,g,h,i,k){k[0]=e*h;k[1]=c*h;k[3]=-c*i;k[4]=e*i;k[6]=x-(f*k[0])-(g*k[3]);k[7]=y-(f*k[1])-(g*k[4])},transform:function(m,x,y,c,e,f,g,h,i,k){k[0]=(e*m[0])+(c*m[3]);k[1]=(e*m[1])+(c*m[4]);k[3]=(e*m[3])-(c*m[0]);k[4]=(e*m[4])-(c*m[1]);k[6]=-(f*k[0])-(g*k[3])+(x*m[0])+(y*m[3])+m[6];k[7]=-(f*k[1])-(g*k[4])+(x*m[1])+(y*m[4])+m[7];k[0]*=h;k[1]*=h;k[3]*=i;k[4]*=i}};Object.freeze(AGL.Matrix3);(function(){var c=c4(BasePrototypeClass,function c(){BasePrototypeClass.call(this);this.info={"isWebGl2Supported":!1};var h=_crel.call(_d,"canvas");var a;if(a=h.getContext("webgl2")){this.info.isWebGl2Supported=!0;this.info.maxTextureImageUnits=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS);this.info.maxTextureSize=a.getParameter(a.MAX_TEXTURE_SIZE);this.info.maxVertexAttributes=a.getParameter(a.MAX_VERTEX_ATTRIBS);this.info.maxVaryingVectors=a.getParameter(a.MAX_VARYING_VECTORS);this.info.maxVertexUniformVectors=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS);this.info.maxFragmentUniformComponents=a.getParameter(a.MAX_FRAGMENT_UNIFORM_COMPONENTS);this.info.maxFragmentUniformVectors=a.getParameter(a.MAX_FRAGMENT_UNIFORM_VECTORS);this.info.maxVaryingComponents=a.getParameter(a.MAX_VARYING_COMPONENTS)}},function(){this.useTexture=function(a,e,q){a.activeTexture(a.TEXTURE0+e);a.bindTexture(q.target,q.texture);a.texImage2D(q.target,0,a.RGBA,q.width,q.height,0,a.RGBA,a.UNSIGNED_BYTE,q.source);a.texParameteri(q.target,a.TEXTURE_MAX_LEVEL,q.maxLevel);if(q.generateMipmap){a.generateMipmap(q.target);a.flush()};a.texParameteri(q.target,a.TEXTURE_WRAP_S,q.wrapS);a.texParameteri(q.target,a.TEXTURE_WRAP_T,q.wrapT);if(q.generateMipmap){a.texParameteri(q.target,a.TEXTURE_MIN_FILTER,q.minFilter===a.LINEAR?a.LINEAR_MIPMAP_LINEAR:a.NEAREST_MIPMAP_NEAREST)}else{a.texParameteri(q.target,a.TEXTURE_MIN_FILTER,q.minFilter)};a.texParameteri(q.target,a.TEXTURE_MIN_FILTER,q.minFilter);a.texParameteri(q.target,a.TEXTURE_MAG_FILTER,q.magFilter)};this.loadShader=function(p,a,s){var g=a.createShader(a[p]);a.shaderSource(g,s);a.compileShader(g);var m=a.getShaderParameter(g,a.COMPILE_STATUS);if(!m){var n=a.getShaderInfoLog(g);console.log("Error compiling shader "+p+":"+n);a.deleteShader(g);return null};return g};this.loadVertexShader=this.loadShader.bind(this,"VERTEX_SHADER");this.loadFragmentShader=this.loadShader.bind(this,"FRAGMENT_SHADER");this.createProgram=function(a,l,r,t){var j=a.createProgram();map(l,function(b,g){a.attachShader(j,g)});if(r){map(r,function(b,i){a.bindAttribLocation(j,t?t[b]:b,i)})};a.linkProgram(j);var f=a.getProgramParameter(j,a.LINK_STATUS);if(!f){var n=a.getProgramInfoLog(j);console.log("Error in program linking:"+n);a.deleteProgram(j);return null};a.flush();return j};this.getLocationsFor=function(a,j,v){var o={};map(v,function(b,u){o[b]=a[u](j,b)});return o};this.unbindTexture=function(a,k){a.bindTexture(k.target,null)};this.destroyTexture=function(a,k){a.bindTexture(k.target,null);a.deleteTexture(k.texture)};this.isPowerOf2=function(d){return(d&(d-1))==0}});AGL.Utils=new c();Object.freeze(AGL.Utils)})();AGL.Texture=c4(BasePrototypeClass,function f(a,d){BasePrototypeClass.call(this);this._source;this._onTextureLoadedBind=this._onTextureLoaded.bind(this);this._generateMipmap=!1;this._loaded=!1;this.isVideo=!1;this.shouldUpdate=!1;this.texture=a.createTexture();this.maxLevel=10;this.target=a.TEXTURE_2D;this.wrapS=a.CLAMP_TO_EDGE;this.wrapT=a.CLAMP_TO_EDGE;this.minFilter=a.NEAREST;this.magFilter=a.NEAREST;this.source=d;this._srcWProp="width";this._srcHProp="height";this._eventType;this._curRenderId=-1},function(e){get(this,"generateMipmap",function(){return this._generateMipmap});get(this,"loaded",function(){return this._loaded});get(this,"width",function(){return this._source[this._srcWProp]});get(this,"height",function(){return this._source[this._srcHProp]});prop(this,"source",{get:function(){return this._source},set:function(v){this._source&&this._source[off](this._eventType,this._onTextureLoadedBind);this._source=v;this.isVideo=this._getSourceType()==="video";this._eventType=this.isVideo?"canplay":"load";this._parseTextureSize();this._source[on](this._eventType,this._onTextureLoadedBind)}});this.autoUpdate=function(h){var i=h<this._curRenderId;this._curRenderId=h;return i&&(this.shouldUpdate||(this.isVideo&&!this._source.paused))};this.destruct=function(){this._source&&this._source[off](this._eventType,this._onTextureLoadedBind);e.destruct.call(this)};this._parseTextureSize=function(){this._srcWProp="naturalWidth";this._srcHProp="naturalHeight";if(!this._source[this._srcWProp]){this._srcWProp="videoWidth";this._srcHProp="videoHeight"};if(!this._source[this._srcWProp]){this._srcWProp="width";this._srcHProp="height"};this._generateMipmap=AGL.Utils.isPowerOf2(this.width)&&AGL.Utils.isPowerOf2(this.height);this._loaded=this._getSourceType()==="canvas"||this.width>0&&this.height>0};this._getSourceType=function(){return this._source.tagName.toLowerCase()};this._onTextureLoaded=this._parseTextureSize});AGL.Texture.loadImage=function(a,src){var b=_crel.call(_d,"img");var g=new AGL.Texture(a,b);b.src=src;return g};AGL.Texture.loadVideo=function(a,src){var c=_crel.call(_d,"video");var g=new AGL.Texture(a,c);c.src=src;return g};AGL.Item=c4(BasePrototypeClass,function a(){BasePrototypeClass.call(this);cnst(this,"type","item");this.renderable=!0;this.interactive=!1;this.matrixCache=AGL.Matrix3.identity();this.props=new AGL.ItemProps();this.color=new AGL.ColorProps();this.colorCache=this.color.items;this.parent=null},function(c){get(this,"stage",function(){return this.parent?this.parent.stage:null});this.destruct=function(){this.parent&&this.parent.removeChild&&this.parent.removeChild(this);c.destruct.call(this)};this.update=function(e,d){this._updateProps(d)};this._updateProps=function(d){var b=this.props;b.isUpdated()&&this._transformItem(b,d)};this._transformItem=function(b,d){AGL.Matrix3.transform(d.matrixCache,b.x,b.y,b.sinR,b.cosR,b.anchorX,b.anchorY,b.scaledWidth,b.scaledHeight,this.matrixCache)}});cnst(AGL.Item,"TYPE","item");AGL.Light=c4(AGL.Item,function b(a,i,f,e,g,h){AGL.Item.call(this);this._on=!1;this._curWorldPropsId=-1;this._id=a;this._duoId=a*2;this._quadId=a*4;this._lightPositions=i;this._lightVolumes=f;this._lightColors=e;this._lightEffects=g;this._lightZIndices=h;this.effect=new AGL.LightEffectProps();this.effectCache=this.effect.items;this.color.a=0},function(){prop(this,"on",{get:function(){return this._on&&this.stage},set:function(v){this._on=v}});this._updateProps=function(d){var c=this.props;if(this._curWorldPropsId<d.worldPropsUpdateId||c.isUpdated()){if(this.on){this._curWorldPropsId=d.worldPropsUpdateId;this._transformItem(c,d);this._lightPositions[this._duoId]=this.matrixCache[6];this._lightPositions[this._duoId+1]=this.matrixCache[7];this._lightVolumes[this._duoId]=1/_m.abs(this.matrixCache[0]);this._lightVolumes[this._duoId+1]=1/_m.abs(this.matrixCache[4]);this._lightZIndices[this._id]=this.props.zIndex;arraySet(this._lightColors,this.colorCache,this._quadId);arraySet(this._lightEffects,this.effectCache,this._quadId)}else this._lightColors[this._quadId+3]=0}}});AGL.Image=c4(AGL.Item,function a(d){AGL.Item.call(this);cnst(this,"type","drawable");this.textureMatrixCache=AGL.Matrix3.identity();this.mask=null;this.tintType=AGL.Image.Tint.NORMAL;this.blendMode=AGL.BlendModes.NORMAL;this.textureProps=new AGL.TextureProps();this.textureCrop=new AGL.TextureCrop();this.textureCropCache=this.textureCrop.items;this.texture=d},function(){this.mouseOver=function(){};this.update=function(){this._updateProps();this._updateTextureProps()};this._updateProps=function(){var b=this.props;b.isUpdated()&&this._transformItem(b,this.matrixCache)};this._updateTextureProps=function(){var e=this.textureProps;e.isUpdated()&&this._transformItem(e,this.textureMatrixCache)};this._transformItem=function(b,c){AGL.Matrix3.transformLocal(b.x,b.y,b.sinR,b.cosR,b.anchorX,b.anchorY,b.scaledWidth,b.scaledHeight,c)}});cnst(AGL.Image,"TYPE","drawable");cnst(AGL.Image,"Tint",{"NORMAL":0,"GRAYSCALE":1,"OVERRIDE":2,});AGL.AnimatedImage=c4(AGL.Image,function g(c){AGL.Image.call(this,c);this.frameLength=120;this.frame=0;this.frames=[];this.isPlaying=!1;this._latestUpdate=-1},function(b){this.gotoAndStop=function(a){this.frame=a};this.gotoAndPlay=function(a){this.frame=a;this.play()};this.stop=function(){this.isPlaying=!1};this.play=function(){this.isPlaying=!0};this.update=function(d){this.updateAnimation(d);b.update.call(this)};this.updateAnimation=function(d){if(this.isPlaying){var f=d-this._latestUpdate;if(f>=this.frameLength){this._latestUpdate=d;this.frame+=_m.floor(f/this.frameLength);this.frame>=this.frames.length&&(this.frame=0);var h=this.frames[this.frame];var e=this.textureCrop;e.x=h.x;e.y=h.y;e.width=h.width;e.height=h.height}}};this.destruct=function(){this.stop();b.destruct.call(this)}});AGL.Container=c4(AGL.Item,function h(){AGL.Item.call(this);cnst(this,"type","container");this._curWorldPropsId=-1;this._curWorldColId=-1;this._children=[];this.worldPropsUpdateId=this.worldColorUpdateId=0;this.colorCache=[1,1,1,1]},function(){get(this,"children",function(){return this._children});get(this,"numChildren",function(){return this._children.length});this.clear=function(){while(this.numChildren)this.removeChildAt(0)};this.contains=function(a){return this.getChildIndex(a)>-1};this.addChild=function(a){return this.addChildAt(a,this.numChildren)};this.addChildAt=function(a,b){if(!a)return null;if(a.parent)a.parent.removeChild(a);this._children.push(a);this.setChildIndex(a,b);a.parent=this;return a};this.removeChild=function(a){if(!a||!this.contains(a))return null;_children.remove(a);a.parent=null;return a};this.removeChildAt=function(b){return this.removeChild(this.getChildAt(b))};this.getChildAt=function(b){return this._children[b]};this.setChildIndex=function(a,b){if(!a||b<0)return null;this._children.remove(a);this._children.splice(b,0,a);return a};this.getChildIndex=function(a){return this._children.indexOf(a)};this.swapChildren=function(e,f){var j=this.getChildIndex(e);var k=this.getChildIndex(f);if(j===-1||k===-1)return!1;this.setChildIndex(e,k);this.setChildIndex(f,j);return!0};this.update=function(i,g){this._updateProps(g);this._updateColor(g)};this._updateProps=function(g){var c=this.props;if(this._curWorldPropsId<g.worldPropsUpdateId||c.isUpdated()){this._curWorldPropsId=g.worldPropsUpdateId;this.worldPropsUpdateId++;this._transformItem(c,g)}};this._updateColor=function(g){var d=this.color;if(this._curWorldColId<g.worldColorUpdateId||d.isUpdated()){this._curWorldColId=g.worldColorUpdateId;this.worldColorUpdateId++;var l=g.colorCache;this.colorCache[0]=l[0]*d.r;this.colorCache[1]=l[1]*d.g;this.colorCache[2]=l[2]*d.b;this.colorCache[3]=l[3]*d.a}}});cnst(AGL.Container,"TYPE","container");AGL.BaseRenderer=c4(AGL.Container,function C(p){p.vertexShader=p.vertexShader||AGL.BaseRenderer.createVertexShader;p.fragmentShader=p.fragmentShader||AGL.BaseRenderer.createFragmentShader;Object.freeze(p);AGL.Container.call(this);this.clearColor=new AGL.ColorProps();cnst(this,"_MAX_BATCH_ITEMS",10000);this._clearBeforeRender=!0;this._clearBeforeRenderFunc=this.clear.bind(this);this._w=0;this._h=0;this._resUpdId=0;this._curResUpdId=-1;this._renderId=0;this._latestBlendMode=AGL.BlendModes.NORMAL;this._batchItems=0;this._textureMap=[];this._textureIds=[];this._textureIdBufUpdated=!1;this._config=p;this._canvas=p.canvas;this._context=null;this._gl=this.context;this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);this._gl.enable(this._gl.BLEND);var s=AGL.Utils.createProgram(this._gl,[AGL.Utils.loadVertexShader(this._gl,p.vertexShader(p)),AGL.Utils.loadFragmentShader(this._gl,p.fragmentShader(p))]);this._locations=AGL.Utils.getLocationsFor(this._gl,s,Object.assign(p.locations,{"aPos":"getAttribLocation","aMat":"getAttribLocation","aWorldMat":"getAttribLocation","aTexMat":"getAttribLocation","aTexCrop":"getAttribLocation","uTex":"getUniformLocation",}));this._gl.useProgram(s);this._setBlendMode();var A=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,A);this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,1]),this._gl.STATIC_DRAW);this._gl.vertexAttribPointer(this._locations["aPos"],2,this._gl.FLOAT,!1,0,0);this._gl.enableVertexAttribArray(this._locations["aPos"]);var u=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,u);this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),this._gl.STATIC_DRAW);this._matrixDat=new Float32Array(10000*9);this._matrixBuf=this._createArBuf(this._matrixDat,"aMat",9,3,3,this._gl.FLOAT,4);this._worldMatrixDat=new Float32Array(10000*9);this._worldMatrixBuf=this._createArBuf(this._matrixDat,"aWorldMat",9,3,3,this._gl.FLOAT,4);this._textureMatrixDat=new Float32Array(10000*9);this._textureMatrixBuf=this._createArBuf(this._textureMatrixDat,"aTexMat",9,3,3,this._gl.FLOAT,4);this._textureCropDat=new Float32Array(10000*4);this._textureCropBuf=this._createArBuf(this._textureCropDat,"aTexCrop",4,1,4,this._gl.FLOAT,4);this._drawFunctionMap={};this._drawFunctionMap["item"]=emptyFunction;this._drawFunctionMap["drawable"]=this._drawImage.bind(this);this._drawFunctionMap["container"]=this._drawContainer.bind(this);this._update=this._updateProps=emptyFunction;this._resize()},function(){prop(this,"clearBeforeRender",{get:function(){return this._clearBeforeRender},set:function(v){this._clearBeforeRender=v;this._clearBeforeRenderFunc=v?this.clear.bind(this):emptyFunction}});get(this,"canvas",function(){return this._canvas});get(this,"stage",function(){return this});get(this,"context",function(){if(!this._context||(this._context.isContextLost&&this._context.isContextLost())){this._context=this._canvas.getContext("webgl2",this._config.contextAttributes)};return this._context});prop(this,"width",{get:function(){return this._w},set:function(v){if(this._w!==v){this._w=v;this._resUpdId++}}});prop(this,"height",{get:function(){return this._h},set:function(v){if(this._h!==v){this._h=v;this._resUpdId++}}});this.setSize=function(j,r){this.width=j;this.height=r};this.render=function(){this._resize();this._render()};this.clear=function(){var z=this.clearColor;z.isUpdated()&&this._gl.clearColor(z.r,z.g,z.b,z.a);this._gl.clear(this._gl.COLOR_BUFFER_BIT)};this._render=function(){this._clearBeforeRenderFunc();this._renderTimer=Date.now();this._drawContainer(this);this._batchItems>0&&this._batchDraw();++this._renderId};this._drawItem=function(e,q){if(!e.renderable)return;e.update(this._renderTimer,q);e.type!=="item"&&this._drawFunctionMap[e.type](e,q)};this._drawContainer=function(x){var t=x.children;var i;var l;for(i=0,l=t.length;i<l;++i)this._drawItem(t[i],x)};this._checkBlendMode=function(e){if(this._latestBlendMode!==e.blendMode){this._batchDraw();this._latestBlendMode=e.blendMode;this._setBlendMode()}};this._setBufDat=function(e,q,E,g,n){arraySet(this._worldMatrixDat,q.matrixCache,g);arraySet(this._matrixDat,e.matrixCache,g);arraySet(this._textureMatrixDat,e.textureMatrixCache,g);arraySet(this._textureCropDat,e.textureCropCache,n)};this._drawImage=function(e,q){this._checkBlendMode(e);var E=this._drawTex(e.texture);this._setBufDat(e,q,E,this._batchItems*9,this._batchItems*4);++this._batchItems===10000&&this._batchDraw()};this._createArBuf=function(f,y,m,a,d,c,h){var k=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,k);this._gl.bufferData(this._gl.ARRAY_BUFFER,f.byteLength,this._gl.DYNAMIC_DRAW);this._attachArBuf(this._locations[y],k,f,m,a,d,c,h);return k};this._attachArBuf=function(w,k,f,m,a,d,c,h){this._bindArBuf(k,f);var o=h*m;var i=a+1;while(--i){var b=w+(a-i);this._gl.enableVertexAttribArray(b);this._gl["vertexAttrib"+(c===this._gl.FLOAT?"":"I")+"Pointer"](b,d,c,!1,o,(a-i)*h*d);this._gl.vertexAttribDivisor(b,1)}};this._bindArBuf=function(k,f){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,k);this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,f)};this._bindBufs=function(){this._bindArBuf(this._matrixBuf,this._matrixDat);this._bindArBuf(this._worldMatrixBuf,this._worldMatrixDat);this._bindArBuf(this._textureMatrixBuf,this._textureMatrixDat);this._bindArBuf(this._textureCropBuf,this._textureCropDat)};this._batchDraw=function(){if(this._textureIdBufUpdated){this._textureIdBufUpdated=!1;var D=new Uint16Array(this._textureIds);this._gl.uniform1iv(this._locations["uTex"],D)};this._bindBufs();this._gl.drawElementsInstanced(this._gl.TRIANGLE_FAN,6,this._gl.UNSIGNED_SHORT,0,this._batchItems);this._batchItems=0};this._drawTex=function(B){if(!B.loaded)return 0;var E=this._textureMap.indexOf(B);if(E===-1||B.autoUpdate(this._renderId)){if(E===-1){if(this._textureMap.length===this._config.textureNum){this._batchDraw();this._textureIds.length=this._textureMap.length=0};this._textureMap.push(B);E=this._textureMap.length-1;this._textureIds.push(E);this._textureIdBufUpdated=!0};AGL.Utils.useTexture(this._gl,E,B)};return E+1};this._setBlendMode=function(){this._gl[this._latestBlendMode.funcName](this._gl[this._latestBlendMode.funcs[0]],this._gl[this._latestBlendMode.funcs[1]],this._gl[this._latestBlendMode.funcs[2]],this._gl[this._latestBlendMode.funcs[3]])};this._resize=function(){if(this._resUpdId===this._curResUpdId)return!1;this._curResUpdId=this._resUpdId;this._canvas.width=this._w;this._canvas.height=this._h;this._gl.viewport(0,0,this._gl.drawingBufferWidth,this._gl.drawingBufferHeight);AGL.Matrix3.projection(this._w,this._h,this.matrixCache);this.worldPropsUpdateId++;return!0}});AGL.BaseRenderer.createVertexShader=function(){return"#version 300 es\nin vec2 aPos;in mat3 aMat;in mat3 aWorldMat;in mat3 aTexMat;in vec4 aTexCrop;out vec2 vTexCrd;out vec2 vTexCrop;out vec2 vTexCropSize;void main(void){vec3 pos=vec3(aPos,1);gl_Position=vec4((aWorldMat*aMat*pos).xy,0,1);vTexCrd=(aTexMat*pos).xy;vTexCrop=aTexCrop.xy;vTexCropSize=aTexCrop.zw;}"};AGL.BaseRenderer.createFragmentShader=function(){return"#version 300 es\nprecision lowp float;in vec2 vTexCrd;in vec2 vTexCrop;in vec2 vTexCropSize;out vec4 fgCol;void main(void){fgCol=vec4(1);}"};AGL.PostProcessing=c4(BasePrototypeClass,function j(b){BasePrototypeClass.call(this);b.vertexShader=b.vertexShader||AGL.PostProcessing.createVertexShader;b.fragmentShader=b.fragmentShader||AGL.PostProcessing.createFragmentShader;Object.freeze(b);this.texture=null;this.filters=[];this._w=0;this._h=0;this._resUpdId=0;this._curResUpdId=-1;this._rCount=0;this._config=b;this._canvas=b.canvas;this._context=null;this._gl=this.context;this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);this._gl.enable(this._gl.BLEND);var g=AGL.Utils.createProgram(this._gl,[AGL.Utils.loadVertexShader(this._gl,b.vertexShader(b)),AGL.Utils.loadFragmentShader(this._gl,b.fragmentShader(b))]);this._locations=AGL.Utils.getLocationsFor(this._gl,g,Object.assign(b.locations,{"aPos":"getAttribLocation","uTex":"getUniformLocation","uDspTex":"getUniformLocation","uFlpY":"getUniformLocation","uFtrT":"getUniformLocation","uFtrST":"getUniformLocation","uFtrVal":"getUniformLocation","uTm":"getUniformLocation",}));this._gl.useProgram(g);var h=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,h);this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,1]),this._gl.STATIC_DRAW);this._gl.vertexAttribPointer(this._locations["aPos"],2,this._gl.FLOAT,!1,0,0);this._gl.enableVertexAttribArray(this._locations["aPos"]);this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,1,1,-1]),this._gl.STATIC_DRAW);this._gl.uniform1i(this._locations["uTex"],0);this._gl.uniform1i(this._locations["uDspTex"],1);this._resize()},function(c){get(this,"canvas",function(){return this._canvas});get(this,"context",function(){if(!this._context||(this._context.isContextLost&&this._context.isContextLost())){this._context=this._canvas.getContext("webgl2",this._config.contextAttributes)};return this._context});prop(this,"width",{get:function(){return this._w},set:function(v){if(this._w!==v){this._w=v;this._resUpdId++}}});prop(this,"height",{get:function(){return this._h},set:function(v){if(this._h!==v){this._h=v;this._resUpdId++}}});this.setSize=function(a,d){this.width=a;this.height=d};this.render=function(){this._resize();this._render()};this._render=function(){if(!this.texture.loaded)return;this._gl.clear(this._gl.COLOR_BUFFER_BIT);AGL.Utils.useTexture(this._gl,0,this.texture);this._gl.uniform1f(this._locations["uFlpY"],1);this._gl.uniform1i(this._locations["uFtrT"],0);this._gl.uniform1f(this._locations["uTm"],++this._rCount);this._gl.drawArrays(this._gl.TRIANGLE_FAN,0,6);var i;var l=this.filters.length;for(i=0;i<l;++i){var e=this.filters[i];e.updateFramebuffer(this._gl,this._w,this._h);this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e.framebuffer);this._gl.uniform1f(this._locations["uFlpY"],-1);this._gl.uniform1fv(this._locations["uFtrVal"],e.values);this._gl.uniform1i(this._locations["uFtrT"],e.type);this._gl.uniform1i(this._locations["uFtrST"],e.subType);e.texture&&e.texture.loaded&&AGL.Utils.useTexture(this._gl,1,e.texture);AGL.Utils.useTexture(this._gl,0,this.texture);this._gl.drawArrays(this._gl.TRIANGLE_FAN,0,6);this._gl.bindTexture(this._gl.TEXTURE_2D,e.framebufferTexture)};this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null);this._gl.uniform1f(this._locations["uFlpY"],1);this._gl.uniform1i(this._locations["uFtrT"],0);this._gl.drawArrays(this._gl.TRIANGLE_FAN,0,6)};this._resize=function(){if(this._resUpdId===this._curResUpdId)return!1;this._curResUpdId=this._resUpdId;this._canvas.width=this._w;this._canvas.height=this._h;this._gl.viewport(0,0,this._gl.drawingBufferWidth,this._gl.drawingBufferHeight);return!0}});AGL.PostProcessing.createVertexShader=function(){return"#version 300 es\nin vec2 aPos;uniform float uFlpY;out vec2 vCrd;out vec2 vTexCrd;void main(void){gl_Position=vec4(aPos.xy,0,1);gl_Position.y*=uFlpY;vCrd=aPos;vTexCrd=(aPos+vec2(1,-1))/vec2(2,-2);}"};AGL.PostProcessing.createFragmentShader=function(){var f="#version 300 es\nprecision lowp float;\nuniform sampler2D uTex;uniform sampler2D uDspTex;uniform int uFtrT;uniform int uFtrST;uniform float uFtrVal[9];uniform float uTm;in vec2 vCrd;in vec2 vTexCrd;out vec4 fgCol;vec4 blur(vec4 oCol,float bx, float by,vec2 crd,vec2 oPx){vec4 col=oCol;float w=oPx.x*bx;float h=oPx.y*by;for(float i=-2.;i<3.;++i){for(float j=-2.;j<3.;++j){if(i!=0.&&j!=0.)col+=texture(uTex,crd+vec2(i*w,j*h));}}return col/25.;}vec4 glw(vec4 oCol,float bx, float by,vec2 crd,vec2 oPx){float oAvg=(oCol.r+oCol.g+oCol.b)/3.;vec4 col=oCol;float w=oPx.x*bx;float h=oPx.y*by;float c=1.;for(float i=-3.;i<4.;++i){for(float j=-3.;j<4.;++j){vec4 tCol=texture(uTex,crd+vec2(i*w,j*h));float avg=(tCol.r+tCol.g+tCol.b)/3.;if(avg>oAvg){col+=tCol;c++;}}}return col/c;}vec4 convMat(vec4 oCol,float v[9],vec2 crd,vec2 oPx){return (texture(uTex,crd-oPx)*v[0]+texture(uTex,crd+vec2(0,-oPx.y))*v[1]+texture(uTex,crd+vec2(oPx.x,-oPx.y))*v[2]+texture(uTex,crd+vec2(-oPx.x,0))*v[3]+oCol*v[4]+texture(uTex,crd+vec2(oPx.x,0))*v[5]+texture(uTex,crd+vec2(-oPx.x,oPx.y))*v[6]+texture(uTex,crd+vec2(0,oPx.y))*v[7]+texture(uTex,crd+oPx)*v[8])/9.;}vec4 pxlt(float v,vec2 crd,vec2 oPx){vec2 vol=v*oPx;return texture(uTex,floor(crd/vol)*vol);}void main(void){float[] fvl=uFtrVal;vec2 oPx=vec2(1)/vec2(textureSize(uTex,0));fgCol=texture(uTex,vTexCrd);if(uFtrT>0){if(uFtrT<2)fgCol=convMat(fgCol,fvl,vTexCrd,oPx);else if(uFtrT<3){if(uFtrST<2)fgCol=vec4(vec3((fgCol.r+fgCol.g+fgCol.b)/3.),fgCol.a);else if(uFtrST<3)fgCol=vec4(vec3(.874,.514,.156)*((fgCol.r+fgCol.g+fgCol.b)/3.),fgCol.a);else if(uFtrST<4)fgCol=abs(vec4(fgCol.rgb-1.,fgCol.a));else if(uFtrST<5)fgCol=vec4(fgCol.rgb*vec3(fvl[0],fvl[1],fvl[2]),fgCol.a);else if(uFtrST<6)fgCol=vec4((round((fgCol.rgb*256.)/fvl[0])/256.)*fvl[0],fgCol.a);else if(uFtrST<7)fgCol*=vec4(vec3((1.-sqrt(pow(vCrd.x,4.)+pow(vCrd.y,4.)))),1);else if(uFtrST<8)fgCol+=vec4(vCrd.xy*.15,(vCrd.x-vCrd.y)*.15,0);else if(uFtrST<9)fgCol*=vec4(.2+sin(vCrd.y*500.)*.5);else if(uFtrST<10)fgCol=vec4((fgCol.rgb-.5)*fvl[1]+.5+fvl[0],fgCol.a);else if(uFtrST<11)fgCol=vec4(pow(fgCol.rgb,vec3(fvl[0])),fgCol.a);}else if(uFtrT<4)fgCol=blur(fgCol,fvl[0],fvl[1],vTexCrd,oPx);else if(uFtrT<5)fgCol=pxlt(fvl[0],vTexCrd,oPx);else if(uFtrT<6)fgCol=glw(fgCol,fvl[0],fvl[1],vTexCrd,oPx);else if(uFtrT<7)fgCol=texture(uTex,vTexCrd+(texture(uDspTex,fract(vCrd+uTm*vec2(fvl[1],fvl[2]))).r*oPx*fvl[0]-oPx*fvl[0]*.5));}}";return f};AGL.SimpleRenderer=c4(AGL.BaseRenderer,function h(c){c.vertexShader=c.vertexShader||AGL.SimpleRenderer.createVertexShader;c.fragmentShader=c.fragmentShader||AGL.SimpleRenderer.createFragmentShader;c.locations=Object.assign(c.locations,{"aTexId":"getAttribLocation",});AGL.BaseRenderer.call(this,c);this._texIdDat=new Float32Array(10000);this._texIdBuf=this._createArBuf(this._texIdDat,"aTexId",1,1,1,this._gl.FLOAT,4)},function(d){this._setBufDat=function(a,e,j,b,f){d._setBufDat.call(this,a,e,j,b,f);this._texIdDat[this._batchItems]=j};this._bindBufs=function(){d._bindBufs.call(this);this._bindArBuf(this._texIdBuf,this._texIdDat)}});AGL.SimpleRenderer.createVertexShader=function(){var g="#version 300 es\nin vec2 aPos;in mat3 aMat;in mat3 aWorldMat;in mat3 aTexMat;in vec4 aTexCrop;in float aTexId;out vec2 vTexCrd;out vec2 vTexCrop;out vec2 vTexCropSize;out float vTexId;void main(void){vec3 pos=vec3(aPos,1);gl_Position=vec4((aWorldMat*aMat*pos).xy,0,1);vTexCrd=(aTexMat*pos).xy;vTexCrop=aTexCrop.xy;vTexCropSize=aTexCrop.zw;vTexId=aTexId;}";return g};AGL.SimpleRenderer.createFragmentShader=function(c){var k=c.textureNum;var g="#version 300 es\nprecision lowp float;in vec2 vTexCrd;in vec2 vTexCrop;in vec2 vTexCropSize;in float vTexId;uniform sampler2D uTex["+k+"];out vec4 fgCol;";g+="void main(void){";for(var i=-1;i<k;i++){g+=(i>-1?" else ":"")+"if(vTexId<"+(i+1)+".5){";g+="fgCol="+(i<0?"vec4(0);":"texture(uTex["+i+"],vTexCrop+vTexCropSize*fract(vTexCrd));");g+="}"};g+="}";return g};AGL.MaskRenderer=c4(AGL.SimpleRenderer,function c(a){a.vertexShader=a.vertexShader||AGL.MaskRenderer.createVertexShader;a.fragmentShader=a.fragmentShader||AGL.MaskRenderer.createFragmentShader;AGL.SimpleRenderer.call(this,a);this.clearColor.r=this.clearColor.g=this.clearColor.b=this.clearColor.a=0});AGL.MaskRenderer.createVertexShader=AGL.SimpleRenderer.createVertexShader;AGL.MaskRenderer.createFragmentShader=function(a){var d=a.textureNum;var b="#version 300 es\nprecision lowp float;in vec2 vTexCrd;in vec2 vTexCrop;in vec2 vTexCropSize;in float vTexId;uniform sampler2D uTex["+d+"];out vec4 fgCol;";b+="void main(void){";for(var i=-1;i<d;i++){b+=(i>-1?" else ":"")+"if(vTexId<"+(i+1)+".5){";b+=i<0?"fgCol=vec4(0);":"vec4 col=texture(uTex["+i+"],vTexCrop+vTexCropSize*fract(vTexCrd));fgCol=vec4(1)*((col.r+col.g+col.b+col.a)/4.);";b+="}"};b+="}";return b};AGL.Stage2D=c4(AGL.BaseRenderer,function k(d){d.vertexShader=d.vertexShader||AGL.Stage2D.createVertexShader;d.fragmentShader=d.fragmentShader||AGL.Stage2D.createFragmentShader;d.locations=Object.assign(d.locations,{"aFillCol":"getAttribLocation","aTintCol":"getAttribLocation","aFx":"getAttribLocation","uRes":"getUniformLocation","uLghtPos":"getUniformLocation","uLghtVol":"getUniformLocation","uLghtCol":"getUniformLocation","uLghtFX":"getUniformLocation","uLghtZIndices":"getUniformLocation","uFog":"getUniformLocation",});AGL.BaseRenderer.call(this,d);this.fog=new AGL.ColorProps();this.fog.a=0;this.colorCache=this.color.items;this._DEFAULT_DUO=[0,0];this._DEFAULT_QUAD=[0,0,0,0];this._wHalf=0;this._hHalf=0;this._lights=[];this._picked;this._isPickerSet=!1;this._tmpPickerVector=new Float32Array([0,0,1]);this._tmpMatrix=new Float32Array(6);this._tmpInverseMatrix=new Float32Array(6);this._collectLightsFunc=emptyFunction;if(this._config.isLightEnabled){this._lightPositions=new Float32Array(this._config.lightNum*2);this._lightVolumes=new Float32Array(this._config.lightNum*2);this._lightColors=new Float32Array(this._config.lightNum*4);this._lightEffects=new Float32Array(this._config.lightNum*4);this._lightZIndices=new Int32Array(this._config.lightNum);for(var i=0,l=this._config.lightNum;i<l;++i){this._lights.push(new AGL.Light(i,this._lightPositions,this._lightVolumes,this._lightColors,this._lightEffects,this._lightZIndices))};this._collectLightsFunc=this._collectLights.bind(this)};this._colorDat=new Float32Array(10000*4);this._colorbuf=this._createArBuf(this._colorDat,"aFillCol",4,1,4,this._gl.FLOAT,4);this._tintColorDat=new Float32Array(10000*4);this._tintColorbuf=this._createArBuf(this._tintColorDat,"aTintCol",4,1,4,this._gl.FLOAT,4);this._effectLength=(this._config.isMaskEnabled?4:3);this._effectDat=new Float32Array(10000*this._effectLength);this._effectbuf=this._createArBuf(this._effectDat,"aFx",this._effectLength,1,this._effectLength,this._gl.FLOAT,4);this._setMaskDatFunc=this._config.isMaskEnabled?this._setMaskDat.bind(this):emptyFunction;this._zIndexCounter=0;this._resize()},function(e){get(this,"picked",function(){return this._picked});this.render=function(){this._resize();this._picked=null;this._zIndexCounter=0;this._updateColor();this._updateFog();this._collectLightsFunc();this._render();this._isPickerSet=!1};this.getLight=function(a){return this._lights[a]};this.setPickerPoint=function(x,y){this._isPickerSet=!0;this._tmpPickerVector[0]=(x-this._wHalf)*this.matrixCache[0];this._tmpPickerVector[1]=(y-this._hHalf)*this.matrixCache[4]};this._updateFog=function(){this.fog.isUpdated()&&this._gl.uniform4fv(this._locations["uFog"],this.fog.items)};this._collectLights=function(){this._gl.uniform2fv(this._locations["uLghtPos"],this._lightPositions);this._gl.uniform2fv(this._locations["uLghtVol"],this._lightVolumes);this._gl.uniform4fv(this._locations["uLghtCol"],this._lightColors);this._gl.uniform4fv(this._locations["uLghtFX"],this._lightEffects);this._gl.uniform1fv(this._locations["uLghtZIndices"],this._lightZIndices)};this._drawItem=function(b,f){if(!b.renderable)return;b.props.zIndex=++this._zIndexCounter;b.update(this._renderTimer,f);b.type!=="item"&&this._drawFunctionMap[b.type](b,f)};this._setMaskDat=function(b){b.mask&&(this._effectDat[this._batchItems*this._effectLength+3]=this._drawTex(b.mask))};this._setBufDat=function(b,f,l,c,g,j){e._setBufDat.call(this,b,f,l,c,g);arraySet(this._colorDat,f.colorCache,g);arraySet(this._tintColorDat,b.colorCache,g);this._effectDat[j]=l;this._effectDat[j+1]=b.tintType;this._effectDat[j+2]=b.props.zIndex};this._drawImage=function(b,f){this._checkBlendMode(b);if(this._isPickerSet&&b.interactive&&AGL.Matrix3.isPointInMatrix(this._tmpPickerVector,f.matrixCache,b.matrixCache,this._tmpMatrix,this._tmpInverseMatrix))this._picked=b;this._setMaskDatFunc(b);var l=this._drawTex(b.texture);this._setBufDat(b,f,l,this._batchItems*9,this._batchItems*4,this._batchItems*this._effectLength);++this._batchItems===10000&&this._batchDraw()};this._bindBufs=function(){e._bindBufs.call(this);this._bindArBuf(this._colorbuf,this._colorDat);this._bindArBuf(this._tintColorbuf,this._tintColorDat);this._bindArBuf(this._effectbuf,this._effectDat)};this._resize=function(){if(e._resize.call(this)){this._wHalf=this._w*0.5;this._hHalf=this._h*0.5;this._gl.uniform2f(this._locations["uRes"],this._w/this._h,100/this._w)}};this._updateColor=function(){this.color.isUpdated()&&this.worldColorUpdateId++}});cnst(AGL.Stage2D,"MAX_LIGHT_SOURCES",16);AGL.Stage2D.createVertexShader=function(d){var m=d.lightNum;var h="#version 300 es\n";h+="in vec2 aPos;in mat3 aMat;in mat3 aWorldMat;in mat3 aTexMat;in vec4 aTexCrop;in vec4 aFillCol;in vec4 aTintCol;in vec"+(d.isMaskEnabled?"4":"3")+" aFx;";h+="uniform vec2 uRes;uniform vec4 uFog;";if(d.isLightEnabled){h+="uniform vec2 uLghtPos["+m+"];uniform vec2 uLghtVol["+m+"];uniform vec4 uLghtCol["+m+"];uniform vec4 uLghtFX["+m+"];uniform float uLghtZIndices["+m+"];"};h+="out vec2 vTexCrd;out vec4 vCrd;out vec2 vMskCrd;out vec2 vTexCrop;out vec2 vTexCropSize;out vec4 vFillCol;out vec4 vTintCol;out float vTexId;out float vTintType;out float vColMult;out vec4 vFogCol;";if(d.isMaskEnabled)h+="out float vMskTexId;";if(d.isLightEnabled){h+="vec4 lghtVal(vec4 pos,vec2 lghtPos,vec2 lghtVol,vec4 lghtCol,vec4 lghtFX){vec2 dist=pos.xy-lghtPos;return lghtCol*lghtCol.a*max(0.,min(1.,1.-sqrt(pow(abs(dist.x+(abs(dist.x)*lghtFX.x)),lghtFX.z)*(lghtVol.x/uRes.y)+pow(abs(dist.y+(abs(dist.y)*lghtFX.y)),lghtFX.w)*(lghtVol.y/uRes.x/uRes.y))));}"};h+="void main(void){vec3 pos=vec3(aPos,1);gl_Position=vec4((aWorldMat*aMat*pos).xy,0,1);vTexCrd=(aTexMat*pos).xy;vCrd=gl_Position;vMskCrd=(vCrd.xy+vec2(1,-1))/vec2(2,-2);vTexCrop=aTexCrop.xy;vTexCropSize=aTexCrop.zw;vFillCol=aFillCol;vTintCol=aTintCol;vTexId=aFx.x;vTintType=aFx.y;";h+="vec4 lghtCol=vec4(0);";if(d.isLightEnabled){for(var i=0;i<m;i++){h+="if(uLghtCol["+i+"].a>0. && uLghtZIndices["+i+"]>aFx.z){lghtCol+=lghtVal(vCrd,uLghtPos["+i+"],uLghtVol["+i+"],uLghtCol["+i+"],uLghtFX["+i+"]);}"}};h+="float colLghtMult=max(0.,uFog.a-lghtCol.a);vColMult=max(0.,1.-colLghtMult);vFogCol=vec4(uFog.rgb*colLghtMult,0);vFillCol+=lghtCol;";if(d.isMaskEnabled)h+="vMskTexId=aFx.w;";h+="}";return h};AGL.Stage2D.createFragmentShader=function(d){var n=d.textureNum;var h="#version 300 es\nprecision lowp float;in vec4 vCrd;in vec2 vMskCrd;in vec2 vTexCrd;in vec2 vTexCrop;in vec2 vTexCropSize;in vec4 vFillCol;in vec4 vTintCol;in float vTexId;in float vTintType;in float vColMult;in vec4 vFogCol;";if(d.isMaskEnabled)h+="in float vMskTexId;";h+="uniform sampler2D uTex["+n+"];";h+="out vec4 fgCol;";h+="void main(void){";if(d.isMaskEnabled){h+="float mskAlpha=1.;if(vMskTexId>0.){";for(var i=0;i<n;i++){h+=(i>0?" else ":"")+"if(vMskTexId<"+(i+1)+".5){mskAlpha=texture(uTex["+i+"],vMskCrd).r;if(mskAlpha==0.) discard;}"};h+="}"};for(var i=-1;i<n;i++){h+=(i>-1?" else ":"")+"if(vTexId<"+(i+1)+".5){";h+="fgCol="+(i<0?"vec4(0);":"texture(uTex["+i+"],vTexCrop+vTexCropSize*fract(vTexCrd));");h+="if(fgCol.a==0.) discard;}"};h+="if(fgCol.a>.0){if(vTintType<.5) fgCol*=vTintCol;else if(vTintType<1.5 && fgCol.r==fgCol.g && fgCol.r==fgCol.b) fgCol*=vTintCol;else if(vTintType<2.5) fgCol=vec4((fgCol.rgb*(1.-vTintCol.a))+(vTintCol.rgb*vTintCol.a),fgCol.a);";h+="vec4 finalCol=vec4(fgCol.rgb*vColMult,fgCol.a);fgCol=(finalCol*vFillCol)+vFogCol;";if(d.isMaskEnabled)h+="fgCol.a*=mskAlpha;";h+="}}";return h};AGL.AbstractFilter=c4(BasePrototypeClass,function e(){BasePrototypeClass.call(this);this.type=this.subType=0;this._vals=new Float32Array(9);this._w=this._h=0;this._gl=this._tex=this._frmBuf=null},function(){get(this,"framebufferTexture",function(){return this._tex});get(this,"framebuffer",function(){return this._frmBuf});get(this,"values",function(){return this._vals});prop(this,"intensity",{get:function(){return this._vals[0]},set:function(v){this._vals[0]=v},});this.updateFramebuffer=function(a,b,c){if(b>0&&c>0&&(!this._frmBuf||this._gl!==a||this._w!==b||this._h!==c)){this._tex&&this._gl.deleteTexture(this._tex);this._frmBuf&&this._gl.deleteFramebuffer(this._frmBuf);this._w=b;this._h=c;this._gl=a;this._tex=this._crtTex(a);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this._w,this._h,0,a.RGBA,a.UNSIGNED_BYTE,null);this._frmBuf=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,this._frmBuf);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this._tex,0)}};this._crtTex=function(a){var d=a.createTexture();a.bindTexture(a.TEXTURE_2D,d);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);return d}});cnst(AGL.AbstractFilter,"CONVOLUTE_TYPE",1);cnst(AGL.AbstractFilter,"COLOR_MANIPULATION_TYPE",2);AGL.BlurFilter=c4(AGL.AbstractFilter,function c(b,a){AGL.AbstractFilter.call(this);this.type=3;this.blurX=b;this.blurY=a},function(){prop(this,"blurX",{get:function(){return this._vals[0]},set:function(v){this._vals[0]=v},});prop(this,"blurY",{get:function(){return this._vals[1]},set:function(v){this._vals[1]=v},})});AGL.EdgeDetectFilter=c4(AGL.AbstractFilter,function a(){AGL.AbstractFilter.call(this);this.type=1;this._vals.set([-1,-1,-1,-1,8,-1,-1,-1,-1],0)});AGL.SharpenFilter=c4(AGL.AbstractFilter,function a(){AGL.AbstractFilter.call(this);this.type=1;this._vals.set([-1,-1,-1,-1,16,-1,-1,-1,-1],0)});AGL.PixelateFilter=c4(AGL.AbstractFilter,function b(a){AGL.AbstractFilter.call(this);this.type=4;this.intensity=a});AGL.GlowFilter=c4(AGL.AbstractFilter,function a(b,c){AGL.AbstractFilter.call(this);this.type=5;this.intensityX=b;this.intensityY=c},function(){prop(this,"intensityX",{get:function(){return this._vals[0]},set:function(v){this._vals[0]=v},});prop(this,"intensityY",{get:function(){return this._vals[1]},set:function(v){this._vals[1]=v},})});AGL.AbstractColorFilter=c4(AGL.AbstractFilter,function b(a){AGL.AbstractFilter.call(this);this.type=2;this.subType=a});AGL.GrayscaleFilter=c4(AGL.AbstractColorFilter,function a(){AGL.AbstractColorFilter.call(this,1)});AGL.SepiaFilter=c4(AGL.AbstractColorFilter,function a(){AGL.AbstractColorFilter.call(this,2)});AGL.InvertFilter=c4(AGL.AbstractColorFilter,function a(){AGL.AbstractColorFilter.call(this,3)});AGL.TintFilter=c4(AGL.AbstractColorFilter,function a(r,g,b){AGL.AbstractColorFilter.call(this,4);this.r=r;this.g=g;this.b=b},function(){prop(this,"r",{get:function(){return this._vals[0]},set:function(v){this._vals[0]=v}});prop(this,"g",{get:function(){return this._vals[1]},set:function(v){this._vals[1]=v}});prop(this,"b",{get:function(){return this._vals[2]},set:function(v){this._vals[2]=v}})});AGL.ColorLimitFilter=c4(AGL.AbstractColorFilter,function b(a){AGL.AbstractColorFilter.call(this,5);this.intensity=a});AGL.VignetteFilter=c4(AGL.AbstractColorFilter,function a(){AGL.AbstractColorFilter.call(this,6)});AGL.RainbowFilter=c4(AGL.AbstractColorFilter,function a(){AGL.AbstractColorFilter.call(this,7)});AGL.LinesFilter=c4(AGL.AbstractColorFilter,function a(){AGL.AbstractColorFilter.call(this,8)});AGL.BrightnessContrastFilter=c4(AGL.AbstractColorFilter,function c(b,a){AGL.AbstractColorFilter.call(this,9);this.brightness=b;this.contrast=a},function(){prop(this,"brightness",{get:function(){return this._vals[0]},set:function(v){this._vals[0]=v}});prop(this,"contrast",{get:function(){return this._vals[1]},set:function(v){this._vals[1]=v}})});AGL.GammaFilter=c4(AGL.AbstractColorFilter,function b(a){AGL.AbstractColorFilter.call(this,10);this.intensity=a});AGL.DisplacementFilter=c4(AGL.AbstractFilter,function c(a,b){AGL.AbstractFilter.call(this);console.log(this);this.type=6;this.texture=a;this.intensity=b},function(){prop(this,"x",{get:function(){return this._vals[1]},set:function(v){this._vals[1]=v},});prop(this,"y",{get:function(){return this._vals[2]},set:function(v){this._vals[2]=v},})});}).call({});