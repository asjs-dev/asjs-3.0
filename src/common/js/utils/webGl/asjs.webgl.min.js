(function(){"use strict";trc("AGL 1.0");_w.AGL={};AGL.Matrix3={isPointInMatrix:function(j,b,a,l,o){l[0]=b[0]*a[0]+b[3]*a[1];l[1]=b[1]*a[0]+b[4]*a[1];l[2]=b[0]*a[3]+b[3]*a[4];l[3]=b[1]*a[3]+b[4]*a[4];l[4]=b[0]*a[6]+b[3]*a[7]+b[6];l[5]=b[1]*a[6]+b[4]*a[7]+b[7];var d=1/(l[0]*l[3]-l[2]*l[1]);o[0]=d*l[3];o[1]=-d*l[1];o[2]=-d*l[2];o[3]=d*l[0];o[4]=d*(l[2]*l[5]-l[3]*l[4]);o[5]=-d*(l[0]*l[5]-l[1]*l[4]);var x=j[0]*o[0]+j[1]*o[2]+o[4];var y=j[0]*o[1]+j[1]*o[3]+o[5];return x>=0&&y>=0&&x<=1&&y<=1},identity:function(){return new Float32Array([1,0,0,0,1,0,0,0,1,])},projection:function(n,p,k){k[0]=2/n;k[1]=0;k[2]=0;k[3]=0;k[4]=-2/p;k[5]=0;k[6]=-1;k[7]=1;k[8]=1},transformLocal:function(x,y,c,e,f,g,h,i,k){k[0]=e*h;k[1]=c*h;k[3]=-c*i;k[4]=e*i;k[6]=x-(f*k[0])-(g*k[3]);k[7]=y-(f*k[1])-(g*k[4])},transform:function(m,x,y,c,e,f,g,h,i,k){k[0]=(e*m[0])+(c*m[3]);k[1]=(e*m[1])+(c*m[4]);k[3]=(e*m[3])-(c*m[0]);k[4]=(e*m[4])-(c*m[1]);k[6]=-(f*k[0])-(g*k[3])+(x*m[0])+(y*m[3])+m[6];k[7]=-(f*k[1])-(g*k[4])+(x*m[1])+(y*m[4])+m[7];k[0]*=h;k[1]*=h;k[3]*=i;k[4]*=i}};Object.freeze(AGL.Matrix3);(function(){var c=c4(ASJS.BasePrototypeClass,function c(){this.info={"isWebGl2Supported":!1};var h=_d.createElement("canvas");var a;if(a=h.getContext("webgl2")){this.info.isWebGl2Supported=!0;this.info.maxTextureImageUnits=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS);this.info.maxTextureSize=a.getParameter(a.MAX_TEXTURE_SIZE);this.info.maxVertexAttributes=a.getParameter(a.MAX_VERTEX_ATTRIBS);this.info.maxVaryingVectors=a.getParameter(a.MAX_VARYING_VECTORS);this.info.maxVertexUniformVectors=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS);this.info.maxFragmentUniformComponents=a.getParameter(a.MAX_FRAGMENT_UNIFORM_COMPONENTS);this.info.maxFragmentUniformVectors=a.getParameter(a.MAX_FRAGMENT_UNIFORM_VECTORS);this.info.maxVaryingComponents=a.getParameter(a.MAX_VARYING_COMPONENTS)}},function(){this.useTexture=function(a,e,q){a.activeTexture(a.TEXTURE0+e);a.bindTexture(q.target,q.texture);a.texImage2D(q.target,0,a.RGBA,q.width,q.height,0,a.RGBA,a.UNSIGNED_BYTE,q.source);a.texParameteri(q.target,a.TEXTURE_MAX_LEVEL,q.maxLevel);if(q.generateMipmap){a.generateMipmap(q.target);a.flush()};a.texParameteri(q.target,a.TEXTURE_WRAP_S,q.wrapS);a.texParameteri(q.target,a.TEXTURE_WRAP_T,q.wrapT);if(q.generateMipmap){a.texParameteri(q.target,a.TEXTURE_MIN_FILTER,q.minFilter===a.LINEAR?a.LINEAR_MIPMAP_LINEAR:a.NEAREST_MIPMAP_NEAREST)}else{a.texParameteri(q.target,a.TEXTURE_MIN_FILTER,q.minFilter)};a.texParameteri(q.target,a.TEXTURE_MIN_FILTER,q.minFilter);a.texParameteri(q.target,a.TEXTURE_MAG_FILTER,q.magFilter)};this.loadShader=function(a,p,s){var g=a.createShader(a[p]);a.shaderSource(g,s);a.compileShader(g);var m=a.getShaderParameter(g,a.COMPILE_STATUS);if(!m){var n=a.getShaderInfoLog(g);trc("Error compiling shader "+p+":"+n);a.deleteShader(g);return null};return g};this.createProgram=function(a,l,r,t){var j=a.createProgram();map(l,function(b,g){a.attachShader(j,g)});if(r){map(r,function(b,i){a.bindAttribLocation(j,t?t[b]:b,i)})};a.linkProgram(j);var f=a.getProgramParameter(j,a.LINK_STATUS);if(!f){var n=a.getProgramInfoLog(j);trc("Error in program linking:"+n);a.deleteProgram(j);return null};a.flush();return j};this.getLocationsFor=function(a,j,v){var o={};map(v,function(b,u){o[b]=a[u](j,b)});return o};this.destroyTexture=function(a,k){a.bindTexture(k.target,null);a.deleteTexture(k.texture)};this.isPowerOf2=function(d){return(d&(d-1))==0}});AGL.Utils=new c();AGL.Utils.ShaderType={"VERTEX_SHADER":"VERTEX_SHADER","FRAGMENT_SHADER":"FRAGMENT_SHADER"};Object.freeze(AGL.Utils)})();c0(AGL,"Bitmap",ASJS.DisplayObject,function(b,c){b.clearColor=new AGL.ColorProps();var a;ASJS.CanvasApi.initBaseCanvas(b,c);ovrd(b,c,"new");b.new=function(f,g,d){c.new("canvas");var h={"alpha":(d&&d.alpha)||!1,"antialias":(d&&d.antialias)||!1,"depth":(d&&d.depth)||!1,"stencil":(d&&d.stencil)||!1,"premultipliedAlpha":(d&&d.premultipliedAlpha)||!1,"powerPreference":(d&&d.powerPreference)||"high-performance"};c.prot.contextAttributes=h;c.prot.contextType="webgl2";b.setBitmapSize(f,g);a=b.getContext();a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);a.enable(a.BLEND)};b.clearRect=function(){var e=b.clearColor;e.isUpdated()&&a.clearColor(e.r,e.g,e.b,e.a);a.clear(a.COLOR_BUFFER_BIT)};ovrd(b,c,"destruct");b.destruct=function(){b.clearColor=a=null;b.destructBaseCanvasApi();c.destruct()};b.update=function(){a&&a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight);b[de](AGL.Bitmap.RESIZE)}});msg(AGL.Bitmap,"RESIZE");AGL.CreateConfig=function(options){if(options.textureNum===undefined||options.textureNum>AGL.Utils.info.maxTextureImageUnits){console.warn("Maximum of texture units is "+16);options.textureNum=AGL.Utils.info.maxTextureImageUnits};if(options.lightsNum===undefined)options.lightsNum=0;else if(options.lightsNum>16){console.warn("Maximum of lights is "+16);options.lightsNum=16};var a={"textureNum":options.textureNum,"lightsNum":options.lightsNum,"isLightEnabled":options.lightsNum>0,"isMaskEnabled":options.isMaskEnabled,"filters":options.filters,"isFilterEnabled":options.filters&&options.filters.length>0};Object.freeze(a);return a};(function(){function b(a){return{"funcName":a.length===2?"blendFunc":"blendFuncSeparate","funcs":a}};AGL.BlendModes={"NORMAL":b(["SRC_ALPHA","ONE_MINUS_SRC_ALPHA","ONE","ONE_MINUS_SRC_ALPHA"]),"ADD":b(["SRC_ALPHA","DST_ALPHA","ONE","DST_ALPHA"]),"MULTIPLY":b(["DST_COLOR","ONE_MINUS_SRC_ALPHA"]),"SCREEN":b(["SRC_ALPHA","ONE_MINUS_SRC_COLOR","ONE","ONE_MINUS_SRC_COLOR"]),"OVERLAY":b(["ONE","ONE_MINUS_SRC_ALPHA"])};Object.freeze(AGL.BlendModes)})();AGL.AbstractProps=c4(ASJS.BasePrototypeClass,function b(){this.id=-1;this._curId=-1},function(){this.isUpdated=function(){var a=this._curId!==this.id;this._curId=this.id;return a}});AGL.ColorProps=c4(AGL.AbstractProps,function a(){AGL.AbstractProps.call(this);this.items=[1,1,1,1]},function(){prop(this,"r",{get:function(){return this.items[0]},set:function(v){if(this.items[0]!==v){this.items[0]=v;++this.id}}});prop(this,"g",{get:function(){return this.items[1]},set:function(v){if(this.items[1]!==v){this.items[1]=v;++this.id}}});prop(this,"b",{get:function(){return this.items[2]},set:function(v){if(this.items[2]!==v){this.items[2]=v;++this.id}}});prop(this,"a",{get:function(){return this.items[3]},set:function(v){if(this.items[3]!==v){this.items[3]=v;++this.id}}})});AGL.ItemProps=c4(AGL.AbstractProps,function a(){AGL.AbstractProps.call(this);this._sr=0;this._cr=1;this._x=0;this._y=0;this._zIndex=0;this._rotation=0;this._scaleX=1;this._scaleY=1;this._width=1;this._height=1;this._anchorX=0;this._anchorY=0;this._scaledWidth=1;this._scaledHeight=1},function(){get(this,"sr",function(){return this._sr});get(this,"cr",function(){return this._cr});get(this,"scaledWidth",function(){return this._scaledWidth});get(this,"scaledHeight",function(){return this._scaledHeight});prop(this,"x",{get:function(){return this._x},set:function(v){if(this._x!==v){this._x=v;++this.id}}});prop(this,"y",{get:function(){return this._y},set:function(v){if(this._y!==v){this._y=v;++this.id}}});prop(this,"zIndex",{get:function(){return this._zIndex},set:function(v){this._zIndex!==v&&(this._zIndex=v)}});prop(this,"rotation",{get:function(){return this._rotation},set:function(v){if(this._rotation!==v){this._rotation=v;this._sr=_m.sin(this._rotation);this._cr=_m.cos(this._rotation);++this.id}}});prop(this,"scaleX",{get:function(){return this._scaleX},set:function(v){if(this._scaleX!==v){this._scaleX=v;this._updateScaledWidth();++this.id}}});prop(this,"scaleY",{get:function(){return this._scaleY},set:function(v){if(this._scaleY!==v){this._scaleY=v;this._updateScaledHeight();++this.id}}});prop(this,"width",{get:function(){return this._width},set:function(v){if(this._width!==v){this._width=v;this._updateScaledWidth();++this.id}}});prop(this,"height",{get:function(){return this._height},set:function(v){if(this._height!==v){this._height=v;this._updateScaledHeight();++this.id}}});prop(this,"anchorX",{get:function(){return this._anchorX},set:function(v){if(this._anchorX!==v){this._anchorX=v;++this.id}}});prop(this,"anchorY",{get:function(){return this._anchorY},set:function(v){if(this._anchorY!==v){this._anchorY=v;++this.id}}});this._updateScaledWidth=function(){this._scaledWidth=this._width*this._scaleX};this._updateScaledHeight=function(){this._scaledHeight=this._height*this._scaleY}});AGL.LightEffectProps=c4(AGL.AbstractProps,function a(){AGL.AbstractProps.call(this);this.items=[0,0,2,2]},function(){prop(this,"anchorX",{get:function(){return this.items[0]},set:function(v){if(this.items[0]!==v){this.items[0]=v;++this.id}}});prop(this,"anchorY",{get:function(){return this.items[1]},set:function(v){if(this.items[1]!==v){this.items[1]=v;++this.id}}});prop(this,"quadX",{get:function(){return this.items[2]},set:function(v){if(this.items[2]!==v){this.items[2]=v;++this.id}}});prop(this,"quadY",{get:function(){return this.items[3]},set:function(v){if(this.items[3]!==v){this.items[3]=v;++this.id}}})});AGL.TextureCrop=c4(AGL.AbstractProps,function a(){AGL.AbstractProps.call(this);this.items=[0,0,1,1]},function(){prop(this,"x",{get:function(){return this.items[0]},set:function(v){if(this.items[0]!==v){this.items[0]=v;++this.id}}});prop(this,"y",{get:function(){return this.items[1]},set:function(v){if(this.items[1]!==v){this.items[1]=v;++this.id}}});prop(this,"width",{get:function(){return this.items[2]},set:function(v){if(this.items[2]!==v){this.items[2]=v;++this.id}}});prop(this,"height",{get:function(){return this.items[3]},set:function(v){if(this.items[3]!==v){this.items[3]=v;++this.id}}})});AGL.TextureProps=c4(AGL.AbstractProps,function a(){AGL.AbstractProps.call(this);this._sr=0;this._cr=1;this._x=0;this._y=0;this._rotation=0;this._width=1;this._height=1;this._anchorX=0;this._anchorY=0},function(){get(this,"sr",function(){return this._sr});get(this,"cr",function(){return this._cr});prop(this,"x",{get:function(){return this._x},set:function(v){if(this._x!==v){this._x=v;++this.id}}});prop(this,"y",{get:function(){return this._y},set:function(v){if(this._y!==v){this._y=v;++this.id}}});prop(this,"rotation",{get:function(){return this._rotation},set:function(v){if(this._rotation!==v){this._rotation=v;this._sr=_m.sin(this._rotation);this._cr=_m.cos(this._rotation);++this.id}}});prop(this,"width",{get:function(){return this._width},set:function(v){if(this._width!==v){this._width=v;++this.id}}});prop(this,"height",{get:function(){return this._height},set:function(v){if(this._height!==v){this._height=v;++this.id}}});prop(this,"anchorX",{get:function(){return this._anchorX},set:function(v){if(this._anchorX!==v){this._anchorX=v;++this.id}}});prop(this,"anchorY",{get:function(){return this._anchorY},set:function(v){if(this._anchorY!==v){this._anchorY=v;++this.id}}})});AGL.Texture=c4(ASJS.BasePrototypeClass,function g(a,e){this._source;this._onTextureLoadedBind=this._onTextureLoaded.bind(this);this._generateMipmap=!1;this.asjsEl;this.loaded=!1;this.isVideo=!1;this.shouldUpdate=!1;this.texture=a.createTexture();this.maxLevel=10;this.target=a.TEXTURE_2D;this.wrapS=a.CLAMP_TO_EDGE;this.wrapT=a.CLAMP_TO_EDGE;this.minFilter=a.NEAREST;this.magFilter=a.NEAREST;this.source=e;this._srcWProp="width";this._srcHProp="height";this._curRenderId=-1},function(f){get(this,"generateMipmap",function(){return this._generateMipmap});get(this,"width",function(){return this._source[this._srcWProp]});get(this,"height",function(){return this._source[this._srcHProp]});prop(this,"source",{get:function(){return this._source},set:function(v){this.asjsEl&&this.asjsEl[off](this.isVideo?ASJS.MediaEvent.CAN_PLAY:ASJS.LoaderEvent.LOAD,this._onTextureLoadedBind);this.asjsEl=v;this._source=this.asjsEl.el;this.isVideo=this._source.tagName.toLowerCase()==="video";this._parseTextureSize();this.asjsEl[on](this.isVideo?ASJS.MediaEvent.CAN_PLAY:ASJS.LoaderEvent.LOAD,this._onTextureLoadedBind)}});this.autoUpdate=function(h){var i=h!==this._curRenderId;this._curRenderId=h;return i&&(this.shouldUpdate||(this.isVideo&&!this.asjsEl.paused))};this.destruct=function(){this.asjsEl&&this.asjsEl[off](this.isVideo?ASJS.MediaEvent.CAN_PLAY:ASJS.LoaderEvent.LOAD,this._onTextureLoadedBind);f.destruct.call(this)};this._parseTextureSize=function(){this._srcWProp="naturalWidth";this._srcHProp="naturalHeight";if(!this._source[this._srcWProp]){this._srcWProp="videoWidth";this._srcHProp="videoHeight"};if(!this._source[this._srcWProp]){this._srcWProp="width";this._srcHProp="height"};this._generateMipmap=AGL.Utils.isPowerOf2(this.width)&&AGL.Utils.isPowerOf2(this.height);this.loaded=this.width>0&&this.height>0};this._onTextureLoaded=this._parseTextureSize});rof(AGL.Texture,"loadImage",function(a,b){var c=new ASJS.Image();c.src=b;return new AGL.Texture(a,c)});rof(AGL.Texture,"loadVideo",function(a,b){var d=new ASJS.VideoPlayer();d.src=b;return new AGL.Texture(a,d)});AGL.Item=c4(ASJS.BasePrototypeClass,function a(){cnst(this,"type","item");this.renderable=!0;this.interactive=!1;this.matrixCache=AGL.Matrix3.identity();this.props=new AGL.ItemProps();this.color=new AGL.ColorProps();this.colorCache=this.color.items;this.parent=null},function(c){get(this,"stage",function(){return this.parent?this.parent.stage:null});this.destruct=function(){this.parent&&this.parent.removeChild&&this.parent.removeChild(this);c.destruct.call(this)};this.update=function(e,d){this._updateProps(d)};this._updateProps=function(d){var b=this.props;b.isUpdated()&&this._transformItem(b,d)};this._transformItem=function(b,d){AGL.Matrix3.transform(d.matrixCache,b.x,b.y,b.sr,b.cr,b.anchorX,b.anchorY,b.scaledWidth,b.scaledHeight,this.matrixCache)}});cnst(AGL.Item,"TYPE","item");AGL.Light=c4(AGL.Item,function a(){AGL.Item.call(this);this._curWorldPropsId=-1;this.positionCache=[];this.volumeCache=[];this.effect=new AGL.LightEffectProps();this.effectCache=this.effect.items;this.color.a=0},function(){this._updateProps=function(c){var b=this.props;if(this._curWorldPropsId!==c.worldPropsUpdateId||b.isUpdated()){this._curWorldPropsId=c.worldPropsUpdateId;this._transformItem(b,c);this.positionCache[0]=this.matrixCache[6];this.positionCache[1]=this.matrixCache[7];this.volumeCache[0]=1/_m.abs(this.matrixCache[0]);this.volumeCache[1]=1/_m.abs(this.matrixCache[4])}}});AGL.Image=c4(AGL.Item,function a(d){AGL.Item.call(this);cnst(this,"type","drawable");this.textureMatrixCache=AGL.Matrix3.identity();this.mask=null;this.tintType=AGL.Image.Tint.NORMAL;this.blendMode=AGL.BlendModes.NORMAL;this.textureProps=new AGL.TextureProps();this.textureCrop=new AGL.TextureCrop();this.textureCropCache=this.textureCrop.items;this.texture=d},function(){this.mouseOver=function(){};this.update=function(){this._updateProps();this._updateTextureProps()};this._updateProps=function(){var b=this.props;b.isUpdated()&&this._transformItem(b,this.matrixCache)};this._updateTextureProps=function(){var e=this.textureProps;e.isUpdated()&&this._transformItem(e,this.textureMatrixCache)};this._transformItem=function(b,c){AGL.Matrix3.transformLocal(b.x,b.y,b.sr,b.cr,b.anchorX,b.anchorY,b.scaledWidth,b.scaledHeight,c)}});cnst(AGL.Image,"TYPE","drawable");cnst(AGL.Image,"Tint",{"NORMAL":0,"GRAYSCALE":1,"OVERRIDE":2,});AGL.AnimatedImage=c4(AGL.Image,function g(c){AGL.Image.call(this,c);this.frameLength=120;this.frame=0;this.frames=[];this.isPlaying=!1;this._latestUpdate=-1},function(b){this.gotoAndStop=function(a){this.frame=a};this.gotoAndPlay=function(a){this.frame=a;this.play()};this.stop=function(){this.isPlaying=!1};this.play=function(){this.isPlaying=!0};this.update=function(d){this.updateAnimation(d);b.update.call(this)};this.updateAnimation=function(d){if(this.isPlaying){var f=d-this._latestUpdate;if(f>=this.frameLength){this._latestUpdate=d;this.frame+=_m.floor(f/this.frameLength);this.frame>=this.frames.length&&(this.frame=0);var h=this.frames[this.frame];var e=this.textureCrop;e.x=h.x;e.y=h.y;e.width=h.width;e.height=h.height}}};this.destruct=function(){this.stop();b.destruct.call(this)}});AGL.Container=c4(AGL.Item,function h(){AGL.Item.call(this);cnst(this,"type","container");this._curWorldPropsId=-1;this._curWorldColId=-1;this._children=[];this.worldPropsUpdateId=this.worldColorUpdateId=0;this.colorCache=[1,1,1,1]},function(){get(this,"children",function(){return this._children});get(this,"numChildren",function(){return this._children.length});this.clear=function(){while(this.numChildren)this.removeChildAt(0)};this.contains=function(a){return this.getChildIndex(a)>-1};this.addChild=function(a){return this.addChildAt(a,this.numChildren)};this.addChildAt=function(a,b){if(!a)return null;if(a.parent)a.parent.removeChild(a);this._children.push(a);this.setChildIndex(a,b);a.parent=this;return a};this.removeChild=function(a){if(!a||!this.contains(a))return null;_children.remove(a);a.parent=null;return a};this.removeChildAt=function(b){return this.removeChild(this.getChildAt(b))};this.getChildAt=function(b){return this._children[b]};this.setChildIndex=function(a,b){if(!a||b<0)return null;this._children.remove(a);this._children.splice(b,0,a);return a};this.getChildIndex=function(a){return this._children.indexOf(a)};this.swapChildren=function(e,f){var j=this.getChildIndex(e);var k=this.getChildIndex(f);if(j===-1||k===-1)return!1;this.setChildIndex(e,k);this.setChildIndex(f,j);return!0};this.update=function(i,g){this._updateProps(g);this._updateColor(g)};this._updateProps=function(g){var c=this.props;if(this._curWorldPropsId!==g.worldPropsUpdateId||c.isUpdated()){this._curWorldPropsId=g.worldPropsUpdateId;this.worldPropsUpdateId++;this._transformItem(c,g)}};this._updateColor=function(g){var d=this.color;if(this._curWorldColId!==g.worldColorUpdateId||d.isUpdated()){this._curWorldColId=g.worldColorUpdateId;this.worldColorUpdateId++;var l=g.colorCache;this.colorCache[0]=l[0]*d.r;this.colorCache[1]=l[1]*d.g;this.colorCache[2]=l[2]*d.b;this.colorCache[3]=l[3]*d.a}}});cnst(AGL.Container,"TYPE","container");AGL.BaseRenderer=c4(AGL.Container,function A(x,B,D,v,o){AGL.Container.call(this);this._MAX_BATCH_ITEMS=10000;this._width=0;this._height=0;this._renderId=0;this._latestBlendMode=AGL.BlendModes.NORMAL;this._batchItems=0;this._textureMap=[];this._textureIds=[];this._textureIdBufferUpdated=!1;this._shouldResize=!0;this._config=o;this._onResizeBind=this._onResize.bind(this);this._webGlBitmap=x;this._webGlBitmap[on](AGL.Bitmap.RESIZE,this._onResizeBind);this._gl=this._webGlBitmap.getContext();var r=AGL.Utils.createProgram(this._gl,[AGL.Utils.loadShader(this._gl,AGL.Utils.ShaderType.VERTEX_SHADER,B(this._config)),AGL.Utils.loadShader(this._gl,AGL.Utils.ShaderType.FRAGMENT_SHADER,D(this._config))]);this._locations=AGL.Utils.getLocationsFor(this._gl,r,Object.assign(v||{},{"a_pos":"getAttribLocation","a_mat":"getAttribLocation","a_worldMat":"getAttribLocation","a_texMat":"getAttribLocation","a_texCrop":"getAttribLocation","u_tex":"getUniformLocation",}));this._gl.useProgram(r);this._setBlendMode();var C=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,C);this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array([0.0,0.0,1.0,0.0,1.0,1.0,0.0,1.0]),this._gl.STATIC_DRAW);this._gl.vertexAttribPointer(this._locations["a_pos"],2,this._gl.FLOAT,!1,0,0);this._gl.enableVertexAttribArray(this._locations["a_pos"]);var y=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,y);this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),this._gl.STATIC_DRAW);this._matrixData=new Float32Array(this._MAX_BATCH_ITEMS*9);this._matrixBuffer=this._createArBuf(this._matrixData,"a_mat",9,3,3,this._gl.FLOAT,4);this._worldMatrixData=new Float32Array(this._MAX_BATCH_ITEMS*9);this._worldMatrixBuffer=this._createArBuf(this._matrixData,"a_worldMat",9,3,3,this._gl.FLOAT,4);this._textureMatrixData=new Float32Array(this._MAX_BATCH_ITEMS*9);this._textureMatrixBuffer=this._createArBuf(this._textureMatrixData,"a_texMat",9,3,3,this._gl.FLOAT,4);this._textureCropData=new Float32Array(this._MAX_BATCH_ITEMS*4);this._textureCropBuffer=this._createArBuf(this._textureCropData,"a_texCrop",4,1,4,this._gl.FLOAT,4);this._drawFunctionMap={};this._drawFunctionMap["item"]=emptyFunction;this._drawFunctionMap["drawable"]=this._drawImage.bind(this);this._drawFunctionMap["container"]=this._drawContainer.bind(this);this._update=this._updateProps=emptyFunction;this._resize()},function(q){get(this,"bitmap",function(){return this._webGlBitmap});get(this,"stage",function(){return this});this.render=function(){this._resize();this._render()};this.destruct=function(){this._webGlBitmap[off](AGL.Bitmap.RESIZE,this._onResizeBind);q.destruct.call(this)};this._render=function(){this._webGlBitmap.clearRect();this._renderTimer=Date.now();this._drawContainer(this);this._batchItems>0&&this._batchDraw();++this._renderId};this._drawItem=function(c,k){if(!c.renderable)return;c.update(this._renderTimer,k);c.type!=="item"&&this._drawFunctionMap[c.type](c,k)};this._drawContainer=function(u){var s=u.children;var i;var l;for(i=0,l=s.length;i<l;++i)this._drawItem(s[i],u)};this._checkBlendMode=function(c){if(this._latestBlendMode!==c.blendMode){this._batchDraw();this._latestBlendMode=c.blendMode;this._setBlendMode()}};this._setBufDat=function(c,k,F,h,j){arraySet(this._worldMatrixData,k.matrixCache,h);arraySet(this._matrixData,c.matrixCache,h);arraySet(this._textureMatrixData,c.textureMatrixCache,h);arraySet(this._textureCropData,c.textureCropCache,j)};this._drawImage=function(c,k){this._checkBlendMode(c);var F=this._drawTex(c.texture);this._setBufDat(c,k,F,this._batchItems*9,this._batchItems*4);++this._batchItems===this._MAX_BATCH_ITEMS&&this._batchDraw()};this._createArBuf=function(d,w,m,b,f,e,g){var n=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,n);this._gl.bufferData(this._gl.ARRAY_BUFFER,d.byteLength,this._gl.DYNAMIC_DRAW);this._attachArBuf(this._locations[w],n,d,m,b,f,e,g);return n};this._attachArBuf=function(t,n,d,m,b,f,e,g){this._bindArBuf(n,d);var p=g*m;var i=b+1;while(--i){var a=t+(b-i);this._gl.enableVertexAttribArray(a);this._gl["vertexAttrib"+(e===this._gl.FLOAT?"":"I")+"Pointer"](a,f,e,!1,p,(b-i)*g*f);this._gl.vertexAttribDivisor(a,1)}};this._bindArBuf=function(n,d){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,n);this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,d)};this._bindBufs=function(){this._bindArBuf(this._matrixBuffer,this._matrixData);this._bindArBuf(this._worldMatrixBuffer,this._worldMatrixData);this._bindArBuf(this._textureMatrixBuffer,this._textureMatrixData);this._bindArBuf(this._textureCropBuffer,this._textureCropData)};this._batchDraw=function(){if(this._textureIdBufferUpdated){this._textureIdBufferUpdated=!1;var E=new Uint16Array(this._textureIds);this._gl.uniform1iv(this._locations["u_tex"],E)};this._bindBufs();this._gl.drawElementsInstanced(this._gl.TRIANGLE_FAN,6,this._gl.UNSIGNED_SHORT,0,this._batchItems);this._batchItems=0};this._drawTex=function(z){if(!z.loaded)return 0;var F=this._textureMap.indexOf(z);if(F===-1||z.autoUpdate(this._renderId)){if(F===-1){if(this._textureMap.length===this._config.textureNum){this._batchDraw();this._textureIds.length=this._textureMap.length=0};this._textureMap.push(z);F=this._textureMap.length-1;this._textureIds.push(F);this._textureIdBufferUpdated=!0};AGL.Utils.useTexture(this._gl,F,z)};return F+1};this._setBlendMode=function(){this._gl[this._latestBlendMode.funcName](this._gl[this._latestBlendMode.funcs[0]],this._gl[this._latestBlendMode.funcs[1]],this._gl[this._latestBlendMode.funcs[2]],this._gl[this._latestBlendMode.funcs[3]])};this._resize=function(){if(!this._shouldResize)return!1;this._shouldResize=!1;this._width=this._webGlBitmap.bitmapWidth;this._height=this._webGlBitmap.bitmapHeight;AGL.Matrix3.projection(this._width,this._height,this.matrixCache);this.worldPropsUpdateId++;return!0};this._onResize=function(){this._shouldResize=!0}});rof(AGL.BaseRenderer,"createVertexShader",function(){return"#version 300 es\nin vec2 a_pos;in mat3 a_mat;in mat3 a_worldMat;in mat3 a_texMat;in vec4 a_texCrop;out vec2 v_texCoord;out vec2 v_texCrop;out vec2 v_texCropSize;void main(void){vec3 pos=vec3(a_pos,1.0);gl_Position=vec4((a_worldMat*a_mat*pos).xy,0.0,1.0);v_texCoord=(a_texMat*pos).xy;v_texCrop=a_texCrop.xy;v_texCropSize=a_texCrop.zw-a_texCrop.xy;}"});rof(AGL.BaseRenderer,"createFragmentShader",function(){return"#version 300 es\nprecision lowp float;in vec2 v_texCoord;in vec2 v_texCrop;in vec2 v_texCropSize;out vec4 fgCol;void main(void){fgCol=vec4(1.0,0.0,1.0,1.0);}"});AGL.SimpleRenderer=c4(AGL.BaseRenderer,function k(h,j,l,c){AGL.BaseRenderer.call(this,h,j,l,{"a_texId":"getAttribLocation",},c);this._texIdData=new Float32Array(this._MAX_BATCH_ITEMS);this._texIdBuffer=this._createArBuf(this._texIdData,"a_texId",1,1,1,this._gl.FLOAT,4)},function(d){this._setBufDat=function(a,e,m,b,f){d._setBufDat.call(this,a,e,m,b,f);this._texIdData[this._batchItems]=m};this._bindBufs=function(){d._bindBufs.call(this);this._bindArBuf(this._texIdBuffer,this._texIdData)}});rof(AGL.SimpleRenderer,"createVertexShader",function(){var g="#version 300 es\nin vec2 a_pos;in mat3 a_mat;in mat3 a_worldMat;in mat3 a_texMat;in vec4 a_texCrop;in float a_texId;out vec2 v_texCoord;out vec2 v_texCrop;out vec2 v_texCropSize;out float v_texId;void main(void){vec3 pos=vec3(a_pos,1.0);gl_Position=vec4((a_worldMat*a_mat*pos).xy,0.0,1.0);v_texCoord=(a_texMat*pos).xy;v_texCrop=a_texCrop.xy;v_texCropSize=a_texCrop.zw-a_texCrop.xy;v_texId=a_texId;}";return g});rof(AGL.SimpleRenderer,"createFragmentShader",function(c){var n=c.textureNum;var g="#version 300 es\n#define MAX_TEXTURES "+n+"\nprecision lowp float;in vec2 v_texCoord;in vec2 v_texCrop;in vec2 v_texCropSize;in float v_texId;uniform sampler2D u_tex[MAX_TEXTURES];out vec4 fgCol;";g+="void main(void){";for(var i=-1;i<n;i++){g+=(i>-1?" else ":"")+"if(v_texId<"+(i+1)+".5){";g+="fgCol="+(i<0?"vec4(0.0,0.0,0.0,0.0);":"texture(u_tex["+i+"],v_texCrop+v_texCropSize*fract(v_texCoord));");g+="}"};g+="}";return g});AGL.MaskRenderer=c4(AGL.SimpleRenderer,function d(c,e,f,b){AGL.SimpleRenderer.call(this,c,e,f,b);c.clearColor.r=c.clearColor.g=c.clearColor.b=c.clearColor.a=0});rof(AGL.MaskRenderer,"createVertexShader",AGL.SimpleRenderer.createVertexShader);rof(AGL.MaskRenderer,"createFragmentShader",function(b){var g=b.textureNum;var a="#version 300 es\n#define MAX_TEXTURES "+g+"\nprecision lowp float;in vec2 v_texCoord;in vec2 v_texCrop;in vec2 v_texCropSize;in float v_texId;uniform sampler2D u_tex[MAX_TEXTURES];out vec4 fgCol;";a+="void main(void){";for(var i=-1;i<g;i++){a+=(i>-1?" else ":"")+"if(v_texId<"+(i+1)+".5){";a+=i<0?"fgCol=vec4(0.0,0.0,0.0,0.0);":"vec4 col=texture(u_tex["+i+"],v_texCrop+v_texCropSize*fract(v_texCoord));fgCol=vec4(vec3(1.0)*((col.r+col.g+col.b)/3.0),col.a);";a+="}"};a+="}";return a});AGL.Stage2D=c4(AGL.BaseRenderer,function q(n,o,p,g){AGL.BaseRenderer.call(this,n,o,p,{"a_fillCol":"getAttribLocation","a_tintCol":"getAttribLocation","a_fx":"getAttribLocation","u_res":"getUniformLocation","u_lightPos":"getUniformLocation","u_lightVol":"getUniformLocation","u_lightCol":"getUniformLocation","u_lightFX":"getUniformLocation","u_lightZIndices":"getUniformLocation","u_fog":"getUniformLocation","u_filters":"getUniformLocation",},g);this.fog=new AGL.ColorProps();this.fog.a=0;this.colorCache=this.color.items;this._DEFAULT_DUO=[0,0];this._DEFAULT_QUAD=[0,0,0,0];this._widthHalf=0;this._heightHalf=0;this._attachedLights=[];this._picked;this._isPickerSet=!1;this._tmpPickerVector=new Float32Array([0,0,1]);this._tmpMatrix=new Float32Array(6);this._tmpInverseMatrix=new Float32Array(6);if(this._config.isLightEnabled){this._lightPositions=new Float32Array(this._config.lightsNum*2);this._lightVolumes=new Float32Array(this._config.lightsNum*2);this._lightColors=new Float32Array(this._config.lightsNum*4);this._lightEffects=new Float32Array(this._config.lightsNum*4);this._lightZIndices=new Int32Array(this._config.lightsNum)};this._collectLightsFunc=this._config.isLightEnabled?this._collectLights.bind(this):emptyFunction;this._colorData=new Float32Array(this._MAX_BATCH_ITEMS*4);this._colorBuffer=this._createArBuf(this._colorData,"a_fillCol",4,1,4,this._gl.FLOAT,4);this._tintColorData=new Float32Array(this._MAX_BATCH_ITEMS*4);this._tintColorBuffer=this._createArBuf(this._tintColorData,"a_tintCol",4,1,4,this._gl.FLOAT,4);this._effectLength=(this._config.isMaskEnabled?4:3);this._effectData=new Float32Array(this._MAX_BATCH_ITEMS*this._effectLength);this._effectBuffer=this._createArBuf(this._effectData,"a_fx",this._effectLength,1,this._effectLength,this._gl.FLOAT,4);this._setMaskDataFunc=this._config.isMaskEnabled?this._setMaskData.bind(this):emptyFunction;this._zIndexCounter=0;this._resize()},function(e){set(this,"filters",function(f){this._config.filters&&this._config.filters.length>0&&this._gl.uniform1i(this._locations["u_filters"],f)});get(this,"picked",function(){return this._picked});this.render=function(){this._resize();this._picked=null;this._zIndexCounter=0;this._updateColor();this._updateFog();this._collectLightsFunc();this._render();this._isPickerSet=!1};this.isLightAttached=function(d){return this._attachedLights.has(d)};this.attachLight=function(d){!this.isLightAttached(d)&&this._attachedLights.length<this._config.lightsNum&&this._attachedLights.push(d)};this.detachLight=function(d){this._attachedLights.remove(d)};this.setPickerPoint=function(x,y){this._isPickerSet=!0;this._tmpPickerVector[0]=(x-this._widthHalf)*this.matrixCache[0];this._tmpPickerVector[1]=(y-this._heightHalf)*this.matrixCache[4]};this._updateFog=function(){this.fog.isUpdated()&&this._gl.uniform4fv(this._locations["u_fog"],this.fog.items)};this._collectLights=function(){var d;var b;var k;var i;var l;for(i=0,l=this._config.lightsNum;i<l;++i){b=i*2;k=i*4;if(i>=this._attachedLights.length||!this._attachedLights[i].renderable){arraySet(this._lightPositions,this._DEFAULT_DUO,b);arraySet(this._lightVolumes,this._DEFAULT_DUO,b);arraySet(this._lightColors,this._DEFAULT_QUAD,k);arraySet(this._lightEffects,this._DEFAULT_QUAD,k);this._lightZIndices[i]=-1}else{d=this._attachedLights[i];arraySet(this._lightPositions,d.positionCache,b);arraySet(this._lightVolumes,d.volumeCache,b);arraySet(this._lightColors,d.colorCache,k);arraySet(this._lightEffects,d.effectCache,k);this._lightZIndices[i]=d.props.zIndex}};d=null;this._gl.uniform2fv(this._locations["u_lightPos"],this._lightPositions);this._gl.uniform2fv(this._locations["u_lightVol"],this._lightVolumes);this._gl.uniform4fv(this._locations["u_lightCol"],this._lightColors);this._gl.uniform4fv(this._locations["u_lightFX"],this._lightEffects);this._gl.uniform1fv(this._locations["u_lightZIndices"],this._lightZIndices)};this._drawItem=function(a,h){if(!a.renderable)return;a.props.zIndex=++this._zIndexCounter;a.update(this._renderTimer,h);a.type!=="item"&&this._drawFunctionMap[a.type](a,h)};this._setMaskData=function(a){a.mask&&(this._effectData[this._batchItems*this._effectLength+3]=this._drawTex(a.mask))};this._setBufDat=function(a,h,s,c,k,m){e._setBufDat.call(this,a,h,s,c,k);arraySet(this._colorData,h.colorCache,k);arraySet(this._tintColorData,a.colorCache,k);this._effectData[m]=s;this._effectData[m+1]=a.tintType;this._effectData[m+2]=a.props.zIndex};this._drawImage=function(a,h){this._checkBlendMode(a);if(this._isPickerSet&&a.interactive&&AGL.Matrix3.isPointInMatrix(this._tmpPickerVector,h.matrixCache,a.matrixCache,this._tmpMatrix,this._tmpInverseMatrix))this._picked=a;this._setMaskDataFunc(a);var s=this._drawTex(a.texture);this._setBufDat(a,h,s,this._batchItems*9,this._batchItems*4,this._batchItems*this._effectLength);++this._batchItems===this._MAX_BATCH_ITEMS&&this._batchDraw()};this._bindBufs=function(){e._bindBufs.call(this);this._bindArBuf(this._colorBuffer,this._colorData);this._bindArBuf(this._tintColorBuffer,this._tintColorData);this._bindArBuf(this._effectBuffer,this._effectData)};this._resize=function(){if(e._resize.call(this)){this._widthHalf=this._width*0.5;this._heightHalf=this._height*0.5;this._gl.uniform2f(this._locations["u_res"],this._width/this._height,100/this._width)}};this._updateColor=function(){this.color.isUpdated()&&this.worldColorUpdateId++}});cnst(AGL.Stage2D,"MAX_LIGHT_SOURCES",16);cnst(AGL.Stage2D,"Filters",{"NONE":0,"GRAYSCALE":1,"SEPIA":2,"INVERT":4,"COLORLIMIT":8,"VIGNETTE":16,"RAINBOW":32,"LINES":64,});rof(AGL.Stage2D,"createVertexShader",function(g){var r=g.lightsNum;var j="#version 300 es\n";if(g.isLightEnabled){j+="#define MAX_LIGHT_SOURCES "+r+"\n"};j+="in vec2 a_pos;in mat3 a_mat;in mat3 a_worldMat;in mat3 a_texMat;in vec4 a_texCrop;in vec4 a_fillCol;in vec4 a_tintCol;in vec"+(g.isMaskEnabled?"4":"3")+" a_fx;";j+="uniform vec2 u_res;uniform vec4 u_fog;";if(g.isLightEnabled){j+="uniform vec2 u_lightPos[MAX_LIGHT_SOURCES];uniform vec2 u_lightVol[MAX_LIGHT_SOURCES];uniform vec4 u_lightCol[MAX_LIGHT_SOURCES];uniform vec4 u_lightFX[MAX_LIGHT_SOURCES];uniform float u_lightZIndices[MAX_LIGHT_SOURCES];"};j+="out vec2 v_texCoord;out vec4 v_coord;out vec2 v_texCrop;out vec2 v_texCropSize;out vec4 v_fillCol;out vec4 v_tintCol;out float v_texId;out float v_tintType;out float v_colMult;out vec4 v_fogCol;";if(g.isMaskEnabled)j+="out float v_maskTexId;";if(g.isLightEnabled){j+="vec4 lightVal(vec4 pos,vec2 lightPos,vec2 lightVol,vec4 lightCol,vec4 lightFX){vec2 dist=pos.xy-lightPos;return lightCol*lightCol.a*max(0.0,min(1.0,1.0-sqrt(pow(abs(dist.x+(abs(dist.x)*lightFX.x)),lightFX.z)*(lightVol.x/u_res.y)+pow(abs(dist.y+(abs(dist.y)*lightFX.y)),lightFX.w)*(lightVol.y/u_res.x/u_res.y))));}"};j+="void main(void){vec3 pos=vec3(a_pos,1.0);gl_Position=vec4((a_worldMat*a_mat*pos).xy,0.0,1.0);v_texCoord=(a_texMat*pos).xy;v_coord=gl_Position;v_texCrop=a_texCrop.xy;v_texCropSize=a_texCrop.zw-a_texCrop.xy;v_fillCol=a_fillCol;v_tintCol=a_tintCol;v_texId=a_fx.x;v_tintType=a_fx.y;";j+="vec4 lightCol=vec4(0.0);";if(g.isLightEnabled){for(var i=0;i<r;i++){j+="if(u_lightCol["+i+"].a>0.0 && u_lightZIndices["+i+"]>a_fx.z){lightCol+=lightVal(v_coord,u_lightPos["+i+"],u_lightVol["+i+"],u_lightCol["+i+"],u_lightFX["+i+"]);}"}};j+="float colLightMult=max(0.0,u_fog.a-lightCol.a);v_colMult=max(0.0,1.0-colLightMult);v_fogCol=vec4(u_fog.rgb*colLightMult,0.0);v_fillCol+=lightCol;";if(g.isMaskEnabled)j+="v_maskTexId=a_fx.w;";j+="}";return j});rof(AGL.Stage2D,"createFragmentShader",function(g){var t=g.textureNum;var j="#version 300 es\n#define MAX_TEXTURES "+t+"\n";j+="precision lowp float;in vec4 v_coord;in vec2 v_texCoord;in vec2 v_texCrop;in vec2 v_texCropSize;in vec4 v_fillCol;in vec4 v_tintCol;in float v_texId;in float v_tintType;in float v_colMult;in vec4 v_fogCol;";if(g.isMaskEnabled)j+="in float v_maskTexId;";j+="uniform sampler2D u_tex[MAX_TEXTURES];";if(g.isFilterEnabled)j+="uniform int u_filters;";j+="out vec4 fgCol;";j+="void main(void){";if(g.isMaskEnabled){j+="float maskAlpha=1.0;if(v_maskTexId>0.0){";for(var i=0;i<t;i++){j+=(i>0?" else ":"")+"if(v_maskTexId<"+(i+1)+".5){maskAlpha=texture(u_tex["+i+"],(v_coord.xy+vec2(1.0,-1.0))/vec2(2.0,-2.0)).r;if(maskAlpha==0.0) discard;}"};j+="}"};for(var i=-1;i<t;i++){j+=(i>-1?" else ":"")+"if(v_texId<"+(i+1)+".5){";j+="fgCol="+(i<0?"vec4(0.0,0.0,0.0,0.0);":"texture(u_tex["+i+"],v_texCrop+v_texCropSize*fract(v_texCoord));");j+="if(fgCol.a==0.0) discard;}"};j+="if(fgCol.a>0.0){if(v_tintType<0.5) fgCol*=v_tintCol;else if(v_tintType<1.5 && fgCol.r==fgCol.g && fgCol.r==fgCol.b) fgCol*=v_tintCol;else if(v_tintType<2.5) fgCol=vec4((fgCol.rgb*(1.0-v_tintCol.a))+(v_tintCol.rgb*v_tintCol.a),fgCol.a);";j+="vec4 finalCol=vec4(fgCol.rgb*v_colMult,fgCol.a);fgCol=(finalCol*v_fillCol)+v_fogCol;";if(g.isFilterEnabled){j+="if(u_filters>0 && fgCol.a>0.0){";for(var i=0;i<g.filters.length;i++){j+="if(("+g.filters[i]+" & u_filters)>0){";switch(g.filters[i]){case AGL.Stage2D.Filters.GRAYSCALE:j+="fgCol=vec4(vec3(1.0)*((fgCol.r+fgCol.g+fgCol.b)/3.0),fgCol.a);";break;case AGL.Stage2D.Filters.SEPIA:j+="fgCol=vec4(vec3(0.874,0.514,0.156)*((fgCol.r+(fgCol.g+fgCol.b))/3.0),fgCol.a);";break;case AGL.Stage2D.Filters.INVERT:j+="fgCol=abs(vec4(fgCol.rgb-1.0,fgCol.a));";break;case AGL.Stage2D.Filters.COLORLIMIT:j+="fgCol=vec4((floor((fgCol.rgb*256.0)/32.0)/256.0)*32.0,fgCol.a);";break;case AGL.Stage2D.Filters.VIGNETTE:j+="float vignetteValue=(1.0-sqrt(pow(v_coord.x,4.0)+pow(v_coord.y,4.0)));fgCol*=vec4(vec3(vignetteValue),1);";break;case AGL.Stage2D.Filters.RAINBOW:j+="fgCol+=vec4(v_coord.x*0.15,v_coord.y*0.15,(v_coord.x-v_coord.y)*0.15,0);";break;case AGL.Stage2D.Filters.LINES:j+="fgCol+=vec4(sin(v_coord.y* 500.0)*0.2);";break};j+="}"};j+="}"};if(g.isMaskEnabled)j+="fgCol.a*=maskAlpha;";j+="}}";return j});}).call({});