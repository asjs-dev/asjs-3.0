var WebGl={};c3(WebGl,"Matrix3");WebGl.Matrix3.isPointInMatrix=function(vec,pm,cm,mdst,invDst){mdst[0]=pm[0]*cm[0]+pm[3]*cm[1];mdst[1]=pm[1]*cm[0]+pm[4]*cm[1];mdst[2]=pm[0]*cm[3]+pm[3]*cm[4];mdst[3]=pm[1]*cm[3]+pm[4]*cm[4];mdst[4]=pm[0]*cm[6]+pm[3]*cm[7]+pm[6];mdst[5]=pm[1]*cm[6]+pm[4]*cm[7]+pm[7];var d=1/(mdst[0]*mdst[3]-mdst[2]*mdst[1]);invDst[0]=d*mdst[3];invDst[1]=-d*mdst[1];invDst[2]=-d*mdst[2];invDst[3]=d*mdst[0];invDst[4]=d*(mdst[2]*mdst[5]-mdst[3]*mdst[4]);invDst[5]=-d*(mdst[0]*mdst[5]-mdst[1]*mdst[4]);var x=vec[0]*invDst[0]+vec[1]*invDst[2]+invDst[4];var y=vec[0]*invDst[1]+vec[1]*invDst[3]+invDst[5];return x>=0&&y>=0&&x<=1&&y<=1};WebGl.Matrix3.identity=function(){return new Float32Array([1,0,0,0,1,0,0,0,1,])};WebGl.Matrix3.projection=function(width,height,dst){dst[0]=2/width;dst[1]=0;dst[2]=0;dst[3]=0;dst[4]=-2/height;dst[5]=0;dst[6]=-1;dst[7]=1;dst[8]=1};WebGl.Matrix3.transformLocal=function(x,y,sr,cr,ax,ay,sx,sy,dst){dst[0]=cr*sx;dst[1]=sr*sx;dst[3]=-sr*sy;dst[4]=cr*sy;dst[6]=x-(ax*dst[0])-(ay*dst[3]);dst[7]=y-(ax*dst[1])-(ay*dst[4])};WebGl.Matrix3.transform=function(m,x,y,sr,cr,ax,ay,sx,sy,dst){dst[0]=(cr*m[0])+(sr*m[3]);dst[1]=(cr*m[1])+(sr*m[4]);dst[3]=(cr*m[3])-(sr*m[0]);dst[4]=(cr*m[4])-(sr*m[1]);dst[6]=-(ax*dst[0])-(ay*dst[3])+(x*m[0])+(y*m[3])+m[6];dst[7]=-(ax*dst[1])-(ay*dst[4])+(x*m[1])+(y*m[4])+m[7];dst[0]*=sx;dst[1]*=sx;dst[3]*=sy;dst[4]*=sy};cnst(WebGl.Matrix3,"IDENTITY",WebGl.Matrix3.identity());c1(WebGl,"Utils",ASJS.BaseClass,function(j){j.webGlInfo={};j.new=x;function x(){j.webGlInfo.isWebGl2Supported=_fls;map(["webgl2"],function(a,d){var k=_d.createElement("canvas");var b;if(b=k.getContext(d)){j.webGlInfo.isWebGl2Supported=_tru;j.webGlInfo.maxTextureImageUnits=b.getParameter(b.MAX_TEXTURE_IMAGE_UNITS);j.webGlInfo.maxTextureSize=b.getParameter(b.MAX_TEXTURE_SIZE);j.webGlInfo.maxVertexAttributes=b.getParameter(b.MAX_VERTEX_ATTRIBS);j.webGlInfo.maxVaryingVectors=b.getParameter(b.MAX_VARYING_VECTORS);j.webGlInfo.maxVertexUniformVectors=b.getParameter(b.MAX_VERTEX_UNIFORM_VECTORS);j.webGlInfo.maxFragmentUniformComponents=b.getParameter(b.MAX_FRAGMENT_UNIFORM_COMPONENTS);j.webGlInfo.maxFragmentUniformVectors=b.getParameter(b.MAX_FRAGMENT_UNIFORM_VECTORS);j.webGlInfo.maxVaryingComponents=b.getParameter(b.MAX_VARYING_COMPONENTS)}})};j.useTexture=function(b,f,u){b.activeTexture(b.TEXTURE0+f);b.bindTexture(u.target,u.texture);b.texImage2D(u.target,0,b.RGBA,u.width,u.height,0,b.RGBA,b.UNSIGNED_BYTE,u.source);b.texParameteri(u.target,b.TEXTURE_MAX_LEVEL,u.maxLevel);var y=r(u.width)&&r(u.height);if(y){b.generateMipmap(u.target);b.flush()};b.texParameteri(u.target,b.TEXTURE_WRAP_S,u.wrapS);b.texParameteri(u.target,b.TEXTURE_WRAP_T,u.wrapT);b.texParameteri(u.target,b.TEXTURE_MIN_FILTER,u.minFilter);b.texParameteri(u.target,b.TEXTURE_MAG_FILTER,u.magFilter)};j.loadShader=function(b,s,v){var g=b.createShader(b[s]);b.shaderSource(g,v);b.compileShader(g);var o=b.getShaderParameter(g,b.COMPILE_STATUS);if(!o){var p=b.getShaderInfoLog(g);trc("Error compiling shader "+s+":"+p);b.deleteShader(g);return null};return g};j.createProgram=function(b,m,t,w){var n=b.createProgram();map(m,function(c,g){b.attachShader(n,g)});if(t){map(t,function(c,i){b.bindAttribLocation(n,w?w[c]:c,i)})};b.linkProgram(n);var h=b.getProgramParameter(n,b.LINK_STATUS);if(!h){var p=b.getProgramInfoLog(n);trc("Error in program linking:"+p);b.deleteProgram(n);return null};b.flush();return n};j.getLocationsFor=function(b,n,A){var q={};map(A,function(c,z){q[c]=b[z](n,c)});return q};j.destroyTexture=function(b,l){b.bindTexture(l.target,null);b.deleteTexture(l.texture)};function r(e){return(e&(e-1))==0}});WebGl.Utils.ShaderType={"VERTEX_SHADER":"VERTEX_SHADER","FRAGMENT_SHADER":"FRAGMENT_SHADER"};c0(WebGl,"Bitmap",ASJS.DisplayObject,function(b,c){b.clearColor=new WebGl.ColorProps();var a;ASJS.CanvasApi.initBaseCanvas(b,c);ovrd(b,c,"new");b.new=function(e,f,g){c.new("canvas");if(!g)g={};c.prot.contextAttributes=g;c.prot.contextType="webgl2";b.setBitmapSize(e,f);a=b.getContext();a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,_tru);a.enable(a.BLEND)};b.clearRect=function(){var d=b.clearColor;d.isUpdated()&&a.clearColor(d.r,d.g,d.b,d.a);a.clear(a.COLOR_BUFFER_BIT)};ovrd(b,c,"destruct");b.destruct=function(){b.clearColor=a=null;b.destructBaseCanvasApi();c.destruct()};b.update=function(){a&&a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight);b[de](WebGl.Bitmap.RESIZE)}});msg(WebGl.Bitmap,"RESIZE");c3(WebGl,"Config");rof(WebGl.Config,"create",function(c,b,a){c=_m.min(c,16);return{"lightsNum":c,"showLights":c>0,"useMask":b,"filters":a}});WebGl.AbstractProps=c4(ASJS.BasePrototypeClass,function b(){this.id=-1;this._currentId=-1},function(){this.isUpdated=function(){var a=this._currentId!==this.id;this._currentId=this.id;return a}});WebGl.ColorProps=c4(WebGl.AbstractProps,function a(){WebGl.AbstractProps.call(this);this.items=[1,1,1,1]},function(){prop(this,"r",{get:function(){return this.items[0]},set:function(v){if(this.items[0]!==v){this.items[0]=v;++this.id}}});prop(this,"g",{get:function(){return this.items[1]},set:function(v){if(this.items[1]!==v){this.items[1]=v;++this.id}}});prop(this,"b",{get:function(){return this.items[2]},set:function(v){if(this.items[2]!==v){this.items[2]=v;++this.id}}});prop(this,"a",{get:function(){return this.items[3]},set:function(v){if(this.items[3]!==v){this.items[3]=v;++this.id}}})});WebGl.ItemProps=c4(WebGl.AbstractProps,function a(){WebGl.AbstractProps.call(this);this._sr=0;this._cr=1;this._x=0;this._y=0;this._rotation=0;this._scaleX=1;this._scaleY=1;this._width=1;this._height=1;this._anchorX=0;this._anchorY=0;this._scaledWidth=1;this._scaledHeight=1},function(){get(this,"sr",function(){return this._sr});get(this,"cr",function(){return this._cr});get(this,"scaledWidth",function(){return this._scaledWidth});get(this,"scaledHeight",function(){return this._scaledHeight});prop(this,"x",{get:function(){return this._x},set:function(v){if(this._x!==v){this._x=v;++this.id}}});prop(this,"y",{get:function(){return this._y},set:function(v){if(this._y!==v){this._y=v;++this.id}}});prop(this,"rotation",{get:function(){return this._rotation},set:function(v){if(this._rotation!==v){this._rotation=v;this._sr=_m.sin(this._rotation);this._cr=_m.cos(this._rotation);++this.id}}});prop(this,"scaleX",{get:function(){return this._scaleX},set:function(v){if(this._scaleX!==v){this._scaleX=v;this._updateScaledWidth();++this.id}}});prop(this,"scaleY",{get:function(){return this._scaleY},set:function(v){if(this._scaleY!==v){this._scaleY=v;this._updateScaledHeight();++this.id}}});prop(this,"width",{get:function(){return this._width},set:function(v){if(this._width!==v){this._width=v;this._updateScaledWidth();++this.id}}});prop(this,"height",{get:function(){return this._height},set:function(v){if(this._height!==v){this._height=v;this._updateScaledHeight();++this.id}}});prop(this,"anchorX",{get:function(){return this._anchorX},set:function(v){if(this._anchorX!==v){this._anchorX=v;++this.id}}});prop(this,"anchorY",{get:function(){return this._anchorY},set:function(v){if(this._anchorY!==v){this._anchorY=v;++this.id}}});this._updateScaledWidth=function(){this._scaledWidth=this._width*this._scaleX};this._updateScaledHeight=function(){this._scaledHeight=this._height*this._scaleY}});WebGl.LightEffectProps=c4(WebGl.AbstractProps,function a(){WebGl.AbstractProps.call(this);this.items=[0,0,2,2]},function(){prop(this,"anchorX",{get:function(){return this.items[0]},set:function(v){if(this.items[0]!==v){this.items[0]=v;++this.id}}});prop(this,"anchorY",{get:function(){return this.items[1]},set:function(v){if(this.items[1]!==v){this.items[1]=v;++this.id}}});prop(this,"quadX",{get:function(){return this.items[2]},set:function(v){if(this.items[2]!==v){this.items[2]=v;++this.id}}});prop(this,"quadY",{get:function(){return this.items[3]},set:function(v){if(this.items[3]!==v){this.items[3]=v;++this.id}}})});WebGl.TextureCrop=c4(WebGl.AbstractProps,function a(){WebGl.AbstractProps.call(this);this.items=[0,0,1,1]},function(){prop(this,"x",{get:function(){return this.items[0]},set:function(v){if(this.items[0]!==v){this.items[0]=v;++this.id}}});prop(this,"y",{get:function(){return this.items[1]},set:function(v){if(this.items[1]!==v){this.items[1]=v;++this.id}}});prop(this,"width",{get:function(){return this.items[2]},set:function(v){if(this.items[2]!==v){this.items[2]=v;++this.id}}});prop(this,"height",{get:function(){return this.items[3]},set:function(v){if(this.items[3]!==v){this.items[3]=v;++this.id}}})});WebGl.TextureProps=c4(WebGl.AbstractProps,function a(){WebGl.AbstractProps.call(this);this._sr=0;this._cr=1;this._x=0;this._y=0;this._rotation=0;this._width=1;this._height=1;this._anchorX=0;this._anchorY=0},function(){get(this,"sr",function(){return this._sr});get(this,"cr",function(){return this._cr});prop(this,"x",{get:function(){return this._x},set:function(v){if(this._x!==v){this._x=v;++this.id}}});prop(this,"y",{get:function(){return this._y},set:function(v){if(this._y!==v){this._y=v;++this.id}}});prop(this,"rotation",{get:function(){return this._rotation},set:function(v){if(this._rotation!==v){this._rotation=v;this._sr=_m.sin(this._rotation);this._cr=_m.cos(this._rotation);++this.id}}});prop(this,"width",{get:function(){return this._width},set:function(v){if(this._width!==v){this._width=v;++this.id}}});prop(this,"height",{get:function(){return this._height},set:function(v){if(this._height!==v){this._height=v;++this.id}}});prop(this,"anchorX",{get:function(){return this._anchorX},set:function(v){if(this._anchorX!==v){this._anchorX=v;++this.id}}});prop(this,"anchorY",{get:function(){return this._anchorY},set:function(v){if(this._anchorY!==v){this._anchorY=v;++this.id}}})});c3(WebGl,"BlendModes");WebGl.BlendModes.NORMAL=["SRC_ALPHA","ONE_MINUS_SRC_ALPHA","ONE","ONE_MINUS_SRC_ALPHA"];WebGl.BlendModes.ADD=["SRC_ALPHA","DST_ALPHA","ONE","DST_ALPHA"];WebGl.BlendModes.MULTIPLY=["DST_COLOR","ONE_MINUS_SRC_ALPHA"];WebGl.BlendModes.SCREEN=["SRC_ALPHA","ONE_MINUS_SRC_COLOR","ONE","ONE_MINUS_SRC_COLOR"];WebGl.BlendModes.OVERLAY=["ONE","ONE_MINUS_SRC_ALPHA"];WebGl.Texture=c4(ASJS.BasePrototypeClass,function g(a,e){this._wglUtils=WebGl.Utils.instance;this._source;this._onTextureLoadedBind=this._onTextureLoaded.bind(this);this.asjsEl;this.loaded=_fls;this.isVideo=_fls;this.width=1;this.height=1;this.texture=a.createTexture();this.maxLevel=10;this.target=a.TEXTURE_2D;this.wrapS=a.CLAMP_TO_EDGE;this.wrapT=a.CLAMP_TO_EDGE;this.minFilter=a.NEAREST;this.magFilter=a.NEAREST;this.source=e},function(f){get(this,"autoUpdate",function(){return this.isVideo&&!this.asjsEl.paused});prop(this,"source",{get:function(){return this._source},set:function(v){this.asjsEl&&this.asjsEl[off](this.isVideo?ASJS.MediaEvent.CAN_PLAY:ASJS.LoaderEvent.LOAD,this._onTextureLoadedBind);this.asjsEl=v;this._source=this.asjsEl.el;this.isVideo=this._source.tagName.toLowerCase()==="video";this._parseTextureSize();this.asjsEl[on](this.isVideo?ASJS.MediaEvent.CAN_PLAY:ASJS.LoaderEvent.LOAD,this._onTextureLoadedBind)}});this.destruct=function(){this.asjsEl[off](ASJS.LoaderEvent.LOAD,this._onTextureLoadedBind);this.asjsEl[off](this.isVideo?ASJS.MediaEvent.CAN_PLAY:ASJS.LoaderEvent.LOAD,this._onTextureLoadedBind);f.destruct()};this._parseTextureSize=function(){this.width=this._source.naturalWidth||this._source.videoWidth||this._source.width;this.height=this._source.naturalHeight||this._source.videoHeight||this._source.height;this.loaded=this.width>0&&this.height>0};this._onTextureLoaded=this._parseTextureSize});rof(WebGl.Texture,"loadImage",function(a,b){var c=new ASJS.Image();c.src=b;return new WebGl.Texture(a,c)});rof(WebGl.Texture,"loadVideo",function(a,b){var d=new ASJS.VideoPlayer();d.src=b;return new WebGl.Texture(a,d)});WebGl.Item=c4(ASJS.BasePrototypeClass,function(){cnst(this,"type","item");this._matrixUtils=WebGl.Matrix3;this._transform=this._matrixUtils.transform;this.renderable=_tru;this.interactive=_fls;this.matrixCache=this._matrixUtils.identity();this.props=new WebGl.ItemProps();this.color=new WebGl.ColorProps();this.colorCache=this.color.items;this.parent=null},function(b){get(this,"stage",function(){return this.parent?this.parent.stage:null});this.destruct=function(){this.parent&&this.parent.removeChild&&this.parent.removeChild(this);this.props.destruct();this.color.destruct();b.destruct()};this.update=function(d,c){this._updateProps(c)};this._updateProps=function(c){var a=this.props;a.isUpdated()&&this._transformItem(a,c)};this._transformItem=function(a,c){this._transform(c.matrixCache,a.x,a.y,a.sr,a.cr,a.anchorX,a.anchorY,a.scaledWidth,a.scaledHeight,this.matrixCache)}});cnst(WebGl.Item,"TYPE","item");WebGl.Light=c4(WebGl.Item,function(){WebGl.Item.call(this);this._currentWorldPropsUpdateId=-1;this.positionCache=[];this.volumeCache=[];this.effect=new WebGl.LightEffectProps();this.effectCache=this.effect.items;this.color.a=0},function(b){this.destruct=function(){this.effect.destruct();b.destruct()};this._updateProps=function(c){var a=this.props;if(this._currentWorldPropsUpdateId!==c.worldPropsUpdateId||a.isUpdated()){this._currentWorldPropsUpdateId=c.worldPropsUpdateId;this._transformItem(a,c);this.positionCache[0]=this.matrixCache[6];this.positionCache[1]=this.matrixCache[7];this.volumeCache[0]=1/_m.abs(this.matrixCache[0]);this.volumeCache[1]=1/_m.abs(this.matrixCache[4])}}});WebGl.Image=c4(WebGl.Item,function(d){WebGl.Item.call(this);cnst(this,"type","drawable");var e=WebGl.Matrix3;this._transformLocal=e.transformLocal;this.textureMatrixCache=e.identity();this.mask=null;this.tintType=WebGl.Image.Tint.NORMAL;this.blendMode=WebGl.BlendModes.NORMAL;this.textureProps=new WebGl.TextureProps();this.textureCrop=new WebGl.TextureCrop();this.textureCropCache=this.textureCrop.items;this.texture=d},function(c){this.destruct=function(){this.textureProps.destruct();this.textureCrop.destruct();c.destruct()};this.update=function(){this._updateProps();this._updateTextureProps()};this._updateProps=function(){var a=this.props;a.isUpdated()&&this._transformItem(a,this.matrixCache)};this._updateTextureProps=function(){var f=this.textureProps;f.isUpdated()&&this._transformItem(f,this.textureMatrixCache)};this._transformItem=function(a,b){this._transformLocal(a.x,a.y,a.sr,a.cr,a.anchorX,a.anchorY,a.scaledWidth,a.scaledHeight,b)}});cnst(WebGl.Image,"TYPE","drawable");cnst(WebGl.Image,"Tint",{"NORMAL":0,"GRAYSCALE":1,"OVERRIDE":2,});WebGl.AnimatedImage=c4(WebGl.Image,function(c){WebGl.Image.call(this,c);this.frameLength=120;this.frame=0;this.frames=[];this.isPlaying=_fls;this._latestUpdate=-1},function(b){this.gotoAndStop=function(a){this.frame=a};this.gotoAndPlay=function(a){this.frame=a;this.play()};this.stop=function(){this.isPlaying=_fls};this.play=function(){this.isPlaying=_tru};this.update=function(d){this.updateAnimation(d);b.update.call(this)};this.updateAnimation=function(d){if(this.isPlaying){var f=d-this._latestUpdate;if(f>=this.frameLength){this._latestUpdate=d;this.frame+=_m.floor(f/this.frameLength);this.frame>=this.frames.length&&(this.frame=0);var g=this.frames[this.frame];var e=this.textureCrop;e.x=g.x;e.y=g.y;e.width=g.width;e.height=g.height}}};this.destruct=function(){this.stop();b.destruct()}});WebGl.Container=c4(WebGl.Item,function(){WebGl.Item.call(this);cnst(this,"type","container");this._currentWorldPropsUpdateId=-1;this._currentWorldColorUpdateId=-1;this._children=[];this.worldPropsUpdateId=this.worldColorUpdateId=0;this.colorCache=[1,1,1,1]},function(){get(this,"children",function(){return this._children});get(this,"numChildren",function(){return this._children.length});this.clear=function(){while(this.numChildren)this.removeChildAt(0)};this.contains=function(a){return this.getChildIndex(a)>-1};this.addChild=function(a){return this.addChildAt(a,this.numChildren)};this.addChildAt=function(a,b){if(!a)return null;if(a.parent)a.parent.removeChild(a);this._children.push(a);this.setChildIndex(a,b);a.parent=this;return a};this.removeChild=function(a){if(!a||!this.contains(a))return null;_children.remove(a);a.parent=null;return a};this.removeChildAt=function(b){return this.removeChild(this.getChildAt(b))};this.getChildAt=function(b){return this._children[b]};this.setChildIndex=function(a,b){if(!a||b<0)return null;this._children.remove(a);this._children.splice(b,0,a);return a};this.getChildIndex=function(a){return this._children.indexOf(a)};this.swapChildren=function(e,f){var i=this.getChildIndex(e);var j=this.getChildIndex(f);if(i===-1||j===-1)return _fls;this.setChildIndex(e,j);this.setChildIndex(f,i);return _tru};this.update=function(h,g){this._updateProps(g);this._updateColor(g)};this._updateProps=function(g){var c=this.props;if(this._currentWorldPropsUpdateId!==g.worldPropsUpdateId||c.isUpdated()){this._currentWorldPropsUpdateId=g.worldPropsUpdateId;this.worldPropsUpdateId++;this._transformItem(c,g)}};this._updateColor=function(g){var d=this.color;if(this._currentWorldColorUpdateId!==g.worldColorUpdateId||d.isUpdated()){this._currentWorldColorUpdateId=g.worldColorUpdateId;this.worldColorUpdateId++;var k=g.colorCache;this.colorCache[0]=k[0]*d.r;this.colorCache[1]=k[1]*d.g;this.colorCache[2]=k[2]*d.b;this.colorCache[3]=k[3]*d.a}}});cnst(WebGl.Container,"TYPE","container");WebGl.Stage2D=c4(WebGl.Container,function(E,F,H,t){WebGl.Container.call(this);this._webGlUtils=WebGl.Utils.instance;this._matrixUtils=WebGl.Matrix3;cnst(this,"_MAX_BATCH_ITEMS",10000);cnst(this,"_DEFAULT_DUO",[0,0]);cnst(this,"_DEFAULT_QUAD",[0,0,0,0]);cnst(this,"_SHADER_LOCATIONS",{"a_position":"getAttribLocation","a_matrix":"getAttribLocation","a_worldMatrix":"getAttribLocation","a_texMatrix":"getAttribLocation","a_texCrop":"getAttribLocation","a_fillColor":"getAttribLocation","a_tintColor":"getAttribLocation","a_effects":"getAttribLocation","u_resolution":"getUniformLocation","u_tex":"getUniformLocation","u_lightPositions":"getUniformLocation","u_lightVolumes":"getUniformLocation","u_lightColors":"getUniformLocation","u_lightEffects":"getUniformLocation","u_fog":"getUniformLocation","u_filters":"getUniformLocation",});this.fog=new WebGl.ColorProps();this.colorCache=this.color.items;this._latestBlendMode=WebGl.BlendModes.NORMAL;this._batchItems=0;this._textureMap=[];this._textureIds=[];this._attachedLights=[];this._textureIdBufferUpdated=_fls;this._shouldResize=_tru;this._pickedElements=[];this._isPickerSet=_fls;this._tempPickerVector=new Float32Array([0,0,1]);this._tempMatrix=new Float32Array(6);this._tempInverseMatrix=new Float32Array(6);this._config=t;this._onResizeBind=this._onResize.bind(this);this._webGlBitmap=E;this._webGlBitmap[on](WebGl.Bitmap.RESIZE,this._onResizeBind);this._gl=this._webGlBitmap.getContext();this._program=this._webGlUtils.createProgram(this._gl,[this._webGlUtils.loadShader(this._gl,WebGl.Utils.ShaderType.VERTEX_SHADER,F(this._config)),this._webGlUtils.loadShader(this._gl,WebGl.Utils.ShaderType.FRAGMENT_SHADER,H(this._config))]);this._locations=this._webGlUtils.getLocationsFor(this._gl,this._program,this._SHADER_LOCATIONS);this._gl.useProgram(this._program);this._setBlendMode();var G=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,G);this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array([0.0,0.0,1.0,0.0,1.0,1.0,0.0,1.0]),this._gl.STATIC_DRAW);this._gl.vertexAttribPointer(this._locations["a_position"],2,this._gl.FLOAT,_fls,0,0);this._gl.enableVertexAttribArray(this._locations["a_position"]);var D=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,D);this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),this._gl.STATIC_DRAW);if(this._config.showLights){this._lightPositions=new Float32Array(16*2);this._lightVolumes=new Float32Array(16*2);this._lightColors=new Float32Array(16*4);this._lightEffects=new Float32Array(16*4)};this._collectLightsFunc=this._config.showLights?this._collectLights.bind(this):emptyFunction;this._matrixData=new Float32Array(10000*9);this._matrixBuffer=this._createArrayBuffer(this._matrixData,"a_matrix",9,3,3,this._gl.FLOAT,4);this._worldMatrixData=new Float32Array(10000*9);this._worldMatrixBuffer=this._createArrayBuffer(this._matrixData,"a_worldMatrix",9,3,3,this._gl.FLOAT,4);this._textureMatrixData=new Float32Array(10000*9);this._textureMatrixBuffer=this._createArrayBuffer(this._textureMatrixData,"a_texMatrix",9,3,3,this._gl.FLOAT,4);this._textureCropData=new Float32Array(10000*4);this._textureCropBuffer=this._createArrayBuffer(this._textureCropData,"a_texCrop",4,1,4,this._gl.FLOAT,4);this._colorData=new Float32Array(10000*4);this._colorBuffer=this._createArrayBuffer(this._colorData,"a_fillColor",4,1,4,this._gl.FLOAT,4);this._tintColorData=new Float32Array(10000*4);this._tintColorBuffer=this._createArrayBuffer(this._tintColorData,"a_tintColor",4,1,4,this._gl.FLOAT,4);this._effectLength=(this._config.useMask?3:2);this._effectData=new Float32Array(10000*this._effectLength);this._effectBuffer=this._createArrayBuffer(this._effectData,"a_effects",this._effectLength,1,this._effectLength,this._gl.FLOAT,4);this._setMaskDataFunc=this._config.useMask?this._setMaskData.bind(this):emptyFunction;this._resize();this.fog.a=0;this.filters=WebGl.Stage2D.Filters.NONE;this._drawFunctionMap={};this._drawFunctionMap["item"]=emptyFunction;this._drawFunctionMap["drawable"]=this._drawImage.bind(this);this._drawFunctionMap["container"]=this._drawContainer.bind(this);this._update=this._updateProps=emptyFunction},function(r){set(this,"filters",function(f){this._config.filters&&this._config.filters.length>0&&this._gl.uniform1i(this._locations["u_filters"],f)});get(this,"bitmap",function(){return this._webGlBitmap});get(this,"stage",function(){return this});get(this,"pickedElements",function(){return this._pickedElements.clone()});this.render=function(){this._renderTimer=Date.now();this._pickedElements.length=0;this._resize();this._updateColor();this._updateFog();this._collectLightsFunc();this._drawContainer(this);this._batchItems>0&&this._batchDraw();this._isPickerSet=_fls};this.isLightAttached=function(l){return this._attachedLights.has(l)};this.attachLight=function(l){!this.isLightAttached(l)&&this._attachedLights.length<16&&this._attachedLights.push(l)};this.detachLight=function(l){this._attachedLights.remove(l)};this.setPickerPoint=function(x,y){this._isPickerSet=_tru;this._tempPickerVector[0]=(x-this._widthHalf)*this.matrixCache[0];this._tempPickerVector[1]=(y-this._heightHalf)*this.matrixCache[4]};this.destruct=function(){this._webGlBitmap[off](WebGl.Bitmap.RESIZE,this._onResizeBind);r.destruct()};this._updateFog=function(){var c=this.fog;c.isUpdated()&&this._gl.uniform4fv(this._locations["u_fog"],c.items)};this._collectLights=function(){var l;var m;var u;for(var i=0,l=16;i<l;++i){duoId=i*2;u=i*4;if(i>=this._attachedLights.length||!this._attachedLights[i].renderable){arraySet(this._lightPositions,this._DEFAULT_DUO,duoId);arraySet(this._lightVolumes,this._DEFAULT_DUO,duoId);arraySet(this._lightColors,this._DEFAULT_QUAD,u);arraySet(this._lightEffects,this._DEFAULT_QUAD,u)}else{l=this._attachedLights[i];arraySet(this._lightPositions,l.positionCache,duoId);arraySet(this._lightVolumes,l.volumeCache,duoId);arraySet(this._lightColors,l.colorCache,u);arraySet(this._lightEffects,l.effectCache,u)}};l=null;this._gl.uniform2fv(this._locations["u_lightPositions"],this._lightPositions);this._gl.uniform2fv(this._locations["u_lightVolumes"],this._lightVolumes);this._gl.uniform4fv(this._locations["u_lightColors"],this._lightColors);this._gl.uniform4fv(this._locations["u_lightEffects"],this._lightEffects)};this._drawItem=function(h,q){if(!h.renderable)return;h.update(this._renderTimer,q);h.type!=="item"&&this._drawFunctionMap[h.type](h,q)};this._drawContainer=function(A){var v=A.children;for(var i=0,l=v.length;i<l;++i){this._drawItem(v[i],A)}};this._setMaskData=function(h){h.mask&&(this._effectData[this._batchItems*this._effectLength+2]=this._drawTexture(h.mask))};this._drawImage=function(h,q){if(this._latestBlendMode!==h.blendMode){this._batchDraw();this._latestBlendMode=h.blendMode;this._setBlendMode()};if(this._isPickerSet&&h.interactive&&this._matrixUtils.isPointInMatrix(this._tempPickerVector,q.matrixCache,h.matrixCache,this._tempMatrix,this._tempInverseMatrix))this._pickedElements.push(h);this._setMaskDataFunc(h);var I=this._drawTexture(h.texture);var u=this._batchItems*4;var k=this._batchItems*9;var w=this._batchItems*this._effectLength;arraySet(this._worldMatrixData,q.matrixCache,k);arraySet(this._matrixData,h.matrixCache,k);arraySet(this._textureMatrixData,h.textureMatrixCache,k);arraySet(this._textureCropData,h.textureCropCache,u);arraySet(this._colorData,q.colorCache,u);arraySet(this._tintColorData,h.colorCache,u);this._effectData[w]=I;this._effectData[w+1]=h.tintType;++this._batchItems===10000&&this._batchDraw()};this._createArrayBuffer=function(e,B,n,a,g,d,j){var p=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,p);this._gl.bufferData(this._gl.ARRAY_BUFFER,e.byteLength,this._gl.DYNAMIC_DRAW);this._attachArrayBuffer(this._locations[B],p,e,n,a,g,d,j);return p};this._attachArrayBuffer=function(z,p,e,n,a,g,d,j){this._bindArrayBuffer(p,e);var s=j*n;var i=a+1;while(--i){var b=z+(a-i);this._gl.enableVertexAttribArray(b);this._gl[d===this._gl.FLOAT?"vertexAttribPointer":"vertexAttribIPointer"](b,g,d,_fls,s,(a-i)*j*g);this._gl.vertexAttribDivisor(b,1)}};this._bindArrayBuffer=function(p,e){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,p);this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)};this._batchDraw=function(){if(this._textureIdBufferUpdated){this._textureIdBufferUpdated=_fls;var J=new Uint16Array(this._textureIds);this._gl.uniform1iv(this._locations["u_tex"],J)};this._bindArrayBuffer(this._matrixBuffer,this._matrixData);this._bindArrayBuffer(this._worldMatrixBuffer,this._worldMatrixData);this._bindArrayBuffer(this._textureMatrixBuffer,this._textureMatrixData);this._bindArrayBuffer(this._textureCropBuffer,this._textureCropData);this._bindArrayBuffer(this._colorBuffer,this._colorData);this._bindArrayBuffer(this._tintColorBuffer,this._tintColorData);this._bindArrayBuffer(this._effectBuffer,this._effectData);this._gl.drawElementsInstanced(this._gl.TRIANGLE_FAN,6,this._gl.UNSIGNED_SHORT,0,this._batchItems);this._batchItems=0};this._drawTexture=function(C){if(!C.loaded)return 0;var I=this._textureMap.indexOf(C);if(I===-1||C.autoUpdate){if(I===-1){if(this._textureMap.length===this._webGlUtils.webGlInfo.maxTextureImageUnits){this._batchDraw();this._textureIds.length=this._textureMap.length=0};this._textureMap.push(C);I=this._textureMap.length-1;this._textureIds.push(I);this._textureIdBufferUpdated=_tru};this._webGlUtils.useTexture(this._gl,I,C)};return I+1};this._setBlendMode=function(){this._latestBlendMode.length===4?this._gl.blendFuncSeparate(this._gl[this._latestBlendMode[0]],this._gl[this._latestBlendMode[1]],this._gl[this._latestBlendMode[2]],this._gl[this._latestBlendMode[3]]):this._gl.blendFunc(this._gl[this._latestBlendMode[0]],this._gl[this._latestBlendMode[1]])};this._resize=function(){if(!this._shouldResize)return;this._shouldResize=_fls;this._width=this._webGlBitmap.bitmapWidth;this._height=this._webGlBitmap.bitmapHeight;this._widthHalf=this._width*0.5;this._heightHalf=this._height*0.5;this._matrixUtils.projection(this._width,this._height,this.matrixCache);this._gl.uniform2f(this._locations["u_resolution"],this._width/this._height,100/this._width);this.worldPropsUpdateId++};this._onResize=function(){this._shouldResize=_tru};this._updateColor=function(){this.color.isUpdated()&&this.worldColorUpdateId++}});cnst(WebGl.Stage2D,"MAX_LIGHT_SOURCES",16);rof(WebGl.Stage2D,"createVertexShader",function(t){var o="#version 300 es\nin vec2 a_position;in mat3 a_matrix;in mat3 a_worldMatrix;in mat3 a_texMatrix;in vec4 a_texCrop;in vec4 a_fillColor;in vec4 a_tintColor;in vec"+(t.useMask?"3":"2")+" a_effects;";o+="out vec2 v_texCoord;out vec4 v_coord;out vec2 v_texCrop;out vec2 v_texCropSize;out vec4 v_fillColor;out vec4 v_tintColor;out float v_texId;out float v_tintType;";if(t.useMask)o+="out float v_maskTexId;";o+="void main(void) {vec3 pos = vec3(a_position, 1.0);gl_Position = vec4((a_worldMatrix * a_matrix * pos).xy, 0.0, 1.0);v_texCoord = (a_texMatrix * pos).xy;v_coord = gl_Position;v_texCrop = a_texCrop.xy;v_texCropSize = a_texCrop.zw - a_texCrop.xy;v_fillColor = a_fillColor;v_tintColor = a_tintColor;v_texId = a_effects.x;v_tintType = a_effects.y;";if(t.useMask)o+="v_maskTexId = a_effects.z;";o+="}";return o});rof(WebGl.Stage2D,"createFragmentShader",function(t){var L=WebGl.Utils.instance.webGlInfo.maxTextureImageUnits;var K=t.lightsNum;var o="#version 300 es\n#define MAX_TEXTURES "+L+"\n#define MAX_LIGHT_SOURCES "+K+"\nprecision lowp float;in vec4 v_coord;in vec2 v_texCoord;in vec2 v_texCrop;in vec2 v_texCropSize;in vec4 v_fillColor;in vec4 v_tintColor;in float v_texId;in float v_tintType;";if(t.useMask)o+="in float v_maskTexId;";o+="uniform sampler2D u_tex[MAX_TEXTURES];uniform vec2 u_resolution;uniform vec4 u_fog;";if(t.filters&&t.filters.length>0)o+="uniform int u_filters;";if(t.showLights){o+="uniform vec2 u_lightPositions[MAX_LIGHT_SOURCES];uniform vec2 u_lightVolumes[MAX_LIGHT_SOURCES];uniform vec4 u_lightColors[MAX_LIGHT_SOURCES];uniform vec4 u_lightEffects[MAX_LIGHT_SOURCES];"};o+="out vec4 fragColor;";if(t.showLights){o+="vec4 lightValue(vec2 lightPosition, vec2 lightVolume, vec4 lightColor, vec4 lightEffect) {vec2 dist = v_coord.xy - lightPosition;return lightColor * lightColor.a * max(0.0, min(1.0, 1.0 - sqrt(pow(abs(dist.x + (abs(dist.x) * lightEffect.x)), lightEffect.z) * (lightVolume.x / u_resolution.y) + pow(abs(dist.y + (abs(dist.y) * lightEffect.y)), lightEffect.w) * (lightVolume.y / u_resolution.x / u_resolution.y))));}"};o+="void main(void) {";if(t.useMask){o+="float maskAlpha = 1.0;if (v_maskTexId > 0.0) {";for(var i=0;i<L;i++){o+=(i>0?" else ":"")+"if (v_maskTexId < "+(i+1)+".5) {maskAlpha = texture(u_tex["+i+"], (v_coord.xy + vec2(1.0, -1.0)) / vec2(2.0, -2.0)).a;}"};o+="}"};for(var i=-1;i<L;i++){o+=(i>-1?" else ":"")+"if (v_texId < "+(i+1)+".5) {";o+=i<0?"fragColor = vec4(1.0, 0.0, 1.0, 1.0);":"fragColor = texture(u_tex["+i+"], v_texCrop + v_texCropSize * fract(v_texCoord));";o+="}"};o+="if (fragColor.a > 0.0) {if (v_tintType < 0.5) fragColor *= v_tintColor;else if (v_tintType < 1.5 && fragColor.r == fragColor.g && fragColor.r == fragColor.b) fragColor *= v_tintColor;else if (v_tintType < 2.5) fragColor = vec4((fragColor.rgb * (1.0 - v_tintColor.a)) + (v_tintColor.rgb * v_tintColor.a), fragColor.a);vec4 lightColor = vec4(0.0);";if(t.showLights){for(var i=0;i<K;i++){o+="if (u_lightColors["+i+"].a > 0.0) {lightColor += lightValue(u_lightPositions["+i+"], u_lightVolumes["+i+"], u_lightColors["+i+"], u_lightEffects["+i+"]);}"}};o+="float colorLightMultiply = max(0.0, u_fog.a - lightColor.a);float colorMultiply = max(0.0, 1.0 - colorLightMultiply);vec4 fogColor = vec4(u_fog.rgb * colorLightMultiply, 0.0);vec4 finalColor = vec4(fragColor.rgb * colorMultiply, fragColor.a);fragColor = (finalColor * (v_fillColor + lightColor)) + fogColor;";if(t.filters&&t.filters.length>0){o+="if (u_filters > 0) {";for(var i=0;i<t.filters.length;i++){o+="if (("+t.filters[i]+" & u_filters) > 0) {";switch(t.filters[i]){case WebGl.Stage2D.Filters.GRAYSCALE:o+="fragColor = vec4(vec3(1.0) * ((fragColor.r + (fragColor.g + fragColor.b)) / 3.0), fragColor.a);";break;case WebGl.Stage2D.Filters.SEPIA:o+="fragColor = vec4(vec3(0.874, 0.514, 0.156) * ((fragColor.r + (fragColor.g + fragColor.b)) / 3.0), fragColor.a);";break;case WebGl.Stage2D.Filters.INVERT:o+="fragColor = abs(vec4(fragColor.rgb - 1.0, fragColor.a));";break;case WebGl.Stage2D.Filters.COLORLIMIT:o+="fragColor = vec4((floor((fragColor.rgb * 256.0) / 32.0) / 256.0) * 32.0, fragColor.a);";break;case WebGl.Stage2D.Filters.VIGNETTE:o+="fragColor = vec4(fragColor.rgb * (1.0 - sqrt(pow(v_coord.x, 4.0) + pow(v_coord.y, 4.0))), fragColor.a);";break;case WebGl.Stage2D.Filters.RAINBOW:o+="fragColor = vec4(fragColor.rgb + vec3(v_coord.x * 0.15, v_coord.y * 0.15, (v_coord.x - v_coord.y) * 0.15), fragColor.a);";break;case WebGl.Stage2D.Filters.LINES:o+="fragColor += vec4(sin(v_coord.y * 500.0) * 0.2);";break};o+="}"};o+="}"};if(t.useMask)o+="fragColor.a *= maskAlpha;";o+="}}";return o});cnst(WebGl.Stage2D,"Filters",{"NONE":0,"GRAYSCALE":1,"SEPIA":2,"INVERT":4,"COLORLIMIT":8,"VIGNETTE":16,"RAINBOW":32,"LINES":64,});